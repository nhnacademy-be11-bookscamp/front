<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/no-sidebar}">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê°€ì…</title>
</head>
<body>
<div layout:fragment="content">
    <h1>íšŒì› ê°€ì…</h1>
    <p>ìƒˆë¡œìš´ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

    <form id="memberCreateForm" th:action="@{/members}" method="post">
        <input type="hidden" name="_method" value="put" />
        <div class="form-group">
            <label for="userName">ì•„ì´ë”” (4~20ì):</label>
            <input type="text" id="userName" name="userName" required minlength="4" maxlength="20">
            <button type="button" id="checkIdButton">ì¤‘ë³µ í™•ì¸</button>
            <p id="idCheckMessage" class="error">ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="form-group">
            <label for="password">ë¹„ë°€ë²ˆí˜¸ (8~20ì):</label>
            <input type="password" id="password" name="password" required minlength="8" maxlength="20">
        </div>

        <div class="form-group">
            <label for="name">ì´ë¦„:</label>
            <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
            <label for="email">ì´ë©”ì¼:</label>
            <input type="email" id="email" name="email" required>
        </div>

        <div class="form-group">
            <label for="phone">ì „í™”ë²ˆí˜¸:</label>
            <input type="text" id="phone" name="phone" required>
        </div>

        <div class="form-group">
            <label for="birthDate">ìƒë…„ì›”ì¼:</label>
            <input type="date" id="birthDate" name="birthDate" required>
        </div>

        <button type="submit" id="submitButton" disabled>íšŒì› ê°€ì…</button>
    </form>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            var isIdChecked = false;
            var isIdDuplicated = true;

            var idInput = document.getElementById('userName');
            var checkIdButton = document.getElementById('checkIdButton');
            var idCheckMessage = document.getElementById('idCheckMessage');
            var submitButton = document.getElementById('submitButton');
            var memberCreateForm = document.getElementById('memberCreateForm');

            // ... (ì•„ì´ë”” ì…ë ¥ ì‹œ ìƒíƒœ ì´ˆê¸°í™” ë¡œì§ ìƒëµ) ...
            idInput.addEventListener('input', function() {
                submitButton.disabled = true;
                idCheckMessage.textContent = 'ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                idCheckMessage.classList.remove('success');
                idCheckMessage.classList.add('error');
                isIdChecked = false;
            });

            // 2. ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (fetch API ë° console log ì¶”ê°€)
            checkIdButton.addEventListener('click', async function() {
                var id = idInput.value;

                if (id.length < 4 || id.length > 20) {
                    idCheckMessage.textContent = "ì•„ì´ë””ëŠ” 4ì ì´ìƒ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
                    idCheckMessage.classList.remove('success');
                    idCheckMessage.classList.add('error');
                    isIdChecked = false;
                    submitButton.disabled = true;
                    return;
                }

                const gatewayBaseUrl = 'http://localhost:8080';
                const url = gatewayBaseUrl +'/api-server/member/check-id?id=' + encodeURIComponent(id);

                // ğŸ’¡ ìš”ì²­ URLì„ ì½˜ì†”ì— ì¶œë ¥
                console.log('--- ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ìš”ì²­ ì‹œì‘ ---');
                console.log('Request URL:', url);

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/plain'
                        }
                    });

                    // ğŸ’¡ ì‘ë‹µ ìƒíƒœ ì½”ë“œë¥¼ ì½˜ì†”ì— ì¶œë ¥
                    console.log('Response Status:', response.status, response.statusText);

                    if (!response.ok) {
                        isIdDuplicated = true;
                        submitButton.disabled = true;

                        const errorMessage = await response.text();

                        // ğŸ’¡ ì˜¤ë¥˜ ì‘ë‹µ ë³¸ë¬¸ì„ ì½˜ì†”ì— ì¶œë ¥
                        console.error('Error Response Body:', errorMessage);

                        idCheckMessage.textContent = errorMessage || "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                        idCheckMessage.classList.remove('success');
                        idCheckMessage.classList.add('error');

                    } else {
                        // ì„±ê³µ (200 OK)
                        isIdChecked = true;
                        isIdDuplicated = false;
                        submitButton.disabled = false;

                        const successMessage = await response.text();

                        // ğŸ’¡ ì„±ê³µ ì‘ë‹µ ë³¸ë¬¸ì„ ì½˜ì†”ì— ì¶œë ¥
                        console.log('Success Response Body:', successMessage);

                        idCheckMessage.textContent = successMessage;
                        idCheckMessage.classList.remove('error');
                        idCheckMessage.classList.add('success');
                    }

                    isIdChecked = true;

                } catch (error) {
                    // ğŸ’¡ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ìì²´ì˜ ì‹¤íŒ¨ë¥¼ ì½˜ì†”ì— ì¶œë ¥
                    console.error('Network Fetch Error:', error);
                    idCheckMessage.textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    idCheckMessage.classList.remove('success');
                    idCheckMessage.classList.add('error');
                    isIdChecked = false;
                    isIdDuplicated = true;
                    submitButton.disabled = true;
                } finally {
                    console.log('--- ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ìš”ì²­ ì¢…ë£Œ ---');
                }
            });

            // ... (í¼ ì œì¶œ ì‹œ ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ ìƒëµ) ...
            memberCreateForm.addEventListener('submit', function(e) {
                if (!isIdChecked || isIdDuplicated) {
                    e.preventDefault();
                    alert("ì•„ì´ë”” ì¤‘ë³µ ê²€ì‚¬ë¥¼ ì™„ë£Œí•˜ê³ , ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            });
        });
    </script>

</div>
</body>
</html>