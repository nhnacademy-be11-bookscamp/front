<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>북스캠프 | 주문 상세</title>

    <th:block layout:fragment="extra-css">
        <style>
            .order-detail-title {
                font-size: 1.5rem;
                font-weight: 700;
            }
            .order-detail-subtitle {
                color: #6c757d;
                margin-bottom: 1.5rem;
            }
            .order-summary-pill {
                background-color: #f8f9fa;
                border-radius: 999px;
                padding: 0.75rem 1.25rem;
                display: inline-flex;
                align-items: center;
                gap: 1.5rem;
                font-size: 0.95rem;
            }
            .order-summary-pill .label {
                color: #6c757d;
                margin-right: 0.25rem;
            }
            .section-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 1rem;
            }
            .order-item-row {
                padding: 1rem 0;
                border-top: 1px solid #f1f1f1;
            }
            .order-item-row:last-child {
                border-bottom: 1px solid #f1f1f1;
            }
            .order-item-title {
                font-weight: 500;
                margin-bottom: 0.25rem;
            }
            .order-item-meta {
                font-size: 0.9rem;
                color: #6c757d;
            }
            .order-section {
                margin-top: 2rem;
            }
            .order-section .card {
                border-radius: 0.75rem;
            }
            .order-section .card-body {
                padding: 1.5rem 1.75rem;
            }
            .order-label {
                font-size: 0.9rem;
                color: #6c757d;
            }
            .order-value {
                font-size: 0.95rem;
            }
            .order-total-row {
                border-top: 1px solid #e9ecef;
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                font-weight: 700;
            }
            .return-btn {
                background-color: #dc3545;
                border-color: #dc3545;
            }
            .return-btn:hover {
                background-color: #c82333;
                border-color: #bd2130;
            }
            .return-type-card {
                cursor: pointer;
                transition: all 0.2s;
                border: 2px solid #dee2e6;
            }
            .return-type-card:hover {
                border-color: #0d6efd;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .return-type-card.selected {
                border-color: #0d6efd;
                background-color: #e7f1ff;
            }
            .return-info-text {
                font-size: 0.85rem;
                color: #6c757d;
                line-height: 1.6;
            }
        </style>
    </th:block>
</head>

<body>

<!-- Hero: 빵크럼 + 타이틀 -->
<section class="hero" layout:fragment="hero">
    <div class="container py-3">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a th:href="@{/}">홈</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders/list}">주문 내역</a></li>
                        <li class="breadcrumb-item active" aria-current="page">주문 상세</li>
                    </ol>
                </nav>
                <h2 class="order-detail-title">주문/배송 조회 상세</h2>
                <p class="order-detail-subtitle mb-0">
                    주문하신 상품의 배송 및 결제 정보를 확인하실 수 있습니다.
                </p>
            </div>
        </div>
    </div>
</section>

<!-- 메인 콘텐츠 -->
<div layout:fragment="content">
    <div class="container my-4" th:if="${order != null}">

        <!-- 상단 주문 요약 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div>
                    <div class="mb-2">
                        <span class="badge bg-secondary-subtle text-secondary fw-semibold"
                              th:text="${order.orderStatus()}">
                            주문상태
                        </span>
                    </div>
                    <div class="order-summary-pill">
                        <span>
                            <span class="label">주문일</span>
                            <span th:text="${#temporals.format(order.orderDate(), 'yyyy.MM.dd')}"></span>
                        </span>
                        <span>
                            <span class="label">주문번호</span>
                            <span th:text="${order.orderId()}"></span>
                        </span>
                    </div>
                </div>
                <div class="text-md-end d-flex flex-column gap-2">
                    <div>
                        <div class="order-label">결제 금액</div>
                        <div class="fs-5 fw-bold"
                             th:text="${#numbers.formatInteger(order.finalPaymentAmount(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                    <!-- 반품 가능한 상태일 때만 반품 버튼 표시 -->
                    <div th:if="${order.orderStatus() == 'SHIPPED' || order.orderStatus() == 'DELIVERED'}">
                        <button type="button" class="btn btn-danger return-btn" data-bs-toggle="modal" data-bs-target="#returnModal"
                                th:attr="data-order-id=${order.orderId()}">
                            반품 신청
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 배송(상품 목록) 섹션 -->
        <section class="order-section">
            <h3 class="section-title">배송</h3>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(order.items())}">
                        <p class="text-muted mb-0">주문 상품 정보가 없습니다.</p>
                    </div>

                    <div th:each="item : ${order.items()}" class="order-item-row row">
                        <!-- 썸네일 자리는 현재 데이터가 없으므로 비워두고, 제목/정보만 보여줍니다 -->
                        <div class="col-12 col-md-8">
                            <div class="order-item-title" th:text="${item.bookTitle()}"></div>
                            <div class="order-item-meta">
                                수량:
                                <span th:text="${item.orderQuantity()}"></span>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
                            <div class="order-value fw-semibold"
                                 th:text="${#numbers.formatInteger(item.bookTotalAmount(), 3, 'COMMA')} + '원'">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 배송 정보 섹션 -->
        <section class="order-section">
            <h3 class="section-title">배송 정보</h3>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="mb-3">
                        <div class="order-label">수령인 / 전화번호</div>
                        <div class="order-value">
                            <span th:text="${order.recipientName()}"></span>
                            <span th:if="${order.recipientPhone() != null and !order.recipientPhone().isEmpty()}">
                                &nbsp;/&nbsp;<span th:text="${order.recipientPhone()}"></span>
                            </span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="order-label">배송지 정보</div>
                        <div class="order-value" th:text="${order.deliveryAddress()}"></div>
                    </div>
                    <div>
                        <div class="order-label">배송 요청사항</div>
                        <div class="order-value text-muted"
                             th:text="${order.deliveryMemo() != null ? order.deliveryMemo() : '요청사항 없음'}">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 결제 정보 섹션 -->
        <section class="order-section">
            <h3 class="section-title">결제 정보</h3>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row mb-1">
                        <div class="col-6 order-label">상품 금액</div>
                        <div class="col-6 text-end order-value"
                             th:text="${#numbers.formatInteger(order.productAmount(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-6 order-label">배송비</div>
                        <div class="col-6 text-end order-value"
                             th:text="${#numbers.formatInteger(order.deliveryFee(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-6 order-label">포장비</div>
                        <div class="col-6 text-end order-value"
                             th:text="${#numbers.formatInteger(order.packagingFee(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-6 order-label">할인 금액</div>
                        <div class="col-6 text-end order-value text-danger"
                             th:text="'-' + ${#numbers.formatInteger(order.discountAmount(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-6 order-label">사용 포인트</div>
                        <div class="col-6 text-end order-value text-danger"
                             th:text="'-' + ${#numbers.formatInteger(order.usedPoint(), 3, 'COMMA')} + 'P'">
                        </div>
                    </div>

                    <div class="row order-total-row">
                        <div class="col-6">결제 금액</div>
                        <div class="col-6 text-end fs-5"
                             th:text="${#numbers.formatInteger(order.finalPaymentAmount(), 3, 'COMMA')} + '원'">
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- order 가 null 인 경우 -->
    <div class="container my-5" th:if="${order == null}">
        <p class="text-center text-muted">주문 정보를 불러올 수 없습니다.</p>
    </div>

    <!-- 반품 신청 모달 -->
    <div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnModalLabel">반품 신청</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">반품 사유를 선택해주세요.</p>

                    <!-- 단순 변심 카드 -->
                    <div class="card return-type-card mb-3" data-return-type="CHANGE_OF_MIND">
                        <div class="card-body">
                            <h6 class="card-title mb-2">단순 변심</h6>
                            <p class="return-info-text mb-0">
                                • 출고일로부터 10일 이내 반품 가능<br>
                                • 배송비는 환불되지 않습니다<br>
                                • 환불 포인트 = (실제 결제액 - 배송비) + 사용한 포인트 - 적립된 포인트
                            </p>
                        </div>
                    </div>

                    <!-- 파손/파본 카드 -->
                    <div class="card return-type-card" data-return-type="DAMAGED_OR_DEFECTIVE">
                        <div class="card-body">
                            <h6 class="card-title mb-2">파손/파본</h6>
                            <p class="return-info-text mb-0">
                                • 출고일로부터 30일 이내 반품 가능<br>
                                • 배송비 포함 전액 환불<br>
                                • 환불 포인트 = 실제 결제액 + 사용한 포인트 - 적립된 포인트
                            </p>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3 mb-0">
                        <small>
                            <strong>유의사항</strong><br>
                            반품 신청 시 해당 주문으로 적립된 포인트는 회수됩니다.<br>
                            반품이 완료되면 환불 포인트가 즉시 지급됩니다.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="confirmReturnBtn" disabled>반품 신청</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const returnTypeCards = document.querySelectorAll('.return-type-card');
            const confirmReturnBtn = document.getElementById('confirmReturnBtn');
            const returnModal = document.getElementById('returnModal');
            let selectedReturnType = null;
            let currentOrderId = null;

            // 반품 버튼 클릭 시 주문 ID 저장
            const returnBtn = document.querySelector('.return-btn');
            if (returnBtn) {
                returnBtn.addEventListener('click', function() {
                    currentOrderId = this.getAttribute('data-order-id');
                });
            }

            // 반품 사유 카드 선택 이벤트
            returnTypeCards.forEach(card => {
                card.addEventListener('click', function() {
                    // 모든 카드의 선택 상태 제거
                    returnTypeCards.forEach(c => c.classList.remove('selected'));

                    // 현재 카드 선택
                    this.classList.add('selected');
                    selectedReturnType = this.getAttribute('data-return-type');

                    // 확인 버튼 활성화
                    confirmReturnBtn.disabled = false;
                });
            });

            // 반품 신청 확인 버튼 클릭 이벤트
            confirmReturnBtn.addEventListener('click', async function() {
                if (!selectedReturnType || !currentOrderId) {
                    alert('반품 사유를 선택해주세요.');
                    return;
                }

                // 버튼 비활성화 (중복 요청 방지)
                confirmReturnBtn.disabled = true;
                confirmReturnBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>처리 중...';

                try {
                    const response = await fetch(`/orders/${currentOrderId}/return`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            returnType: selectedReturnType
                        }),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Bootstrap 모달 닫기
                        const bsModal = bootstrap.Modal.getInstance(returnModal);
                        bsModal.hide();

                        // 성공 메시지
                        alert(
                            `반품 신청이 완료되었습니다.\n\n` +
                            `주문번호: ${data.orderNumber}\n` +
                            `환불 포인트: ${data.point.toLocaleString()}P\n\n` +
                            `환불 포인트가 즉시 지급되었습니다.`
                        );

                        // 페이지 새로고침
                        window.location.reload();
                    } else {
                        // API에서 에러 메시지를 String으로 반환
                        const errorMessage = await response.text();

                        // 에러 메시지 표시
                        alert(errorMessage || '반품 신청에 실패했습니다.');

                        // 버튼 상태 복원
                        confirmReturnBtn.disabled = false;
                        confirmReturnBtn.textContent = '반품 신청';
                    }
                } catch (error) {
                    console.error('반품 신청 오류:', error);
                    alert('반품 신청 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');

                    // 버튼 상태 복원
                    confirmReturnBtn.disabled = false;
                    confirmReturnBtn.textContent = '반품 신청';
                }
            });

            // 모달이 닫힐 때 선택 상태 초기화
            returnModal.addEventListener('hidden.bs.modal', function() {
                returnTypeCards.forEach(card => card.classList.remove('selected'));
                selectedReturnType = null;
                confirmReturnBtn.disabled = true;
                confirmReturnBtn.textContent = '반품 신청';
            });
        });
    </script>
</th:block>

</body>
</html>
