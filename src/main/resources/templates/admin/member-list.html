<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <meta charset="UTF-8">
    <title>회원 관리 | 북스캠프 관리자</title>

    <th:block layout:fragment="extra-css">
        <style>
            /* ===== PAGE WRAPPER (기존 스타일 유지) ===== */
            .pp-page-container {
                background: #ffffff;
                padding: 30px;
                border: 1px solid #ebebeb;
                border-radius: 4px;
            }

            .pp-page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
            }

            .pp-page-title {
                margin: 0;
                font-weight: 700;
                font-size: 20px;
            }

            /* ===== BUTTONS ===== */
            .pp-btn {
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                border-radius: 4px;
                border: 1px solid #ccc;
                font-size: 14px;
                cursor: pointer;
                background: #f8f9fa;
            }

            .pp-btn-primary {
                background: #0064FF;
                color: white;
                border-color: #0064FF;
            }

            .pp-btn-danger {
                background: #dc3545;
                color: white;
                border-color: #dc3545;
            }

            /* ===== TABLE ===== */
            .pp-table {
                width: 100%;
                border-collapse: collapse;
                background-color: #fff;
                table-layout: fixed; /* 컬럼 너비 고정 */
            }

            .pp-table th,
            .pp-table td {
                padding: 10px;
                border: 1px solid #dee2e6;
                font-size: 14px;
                text-align: center;
                vertical-align: middle;
                white-space: nowrap;      /* 줄바꿈 방지 */
                overflow: hidden;         /* 넘치는 텍스트 숨김 */
                text-overflow: ellipsis;  /* ... 처리 */
            }

            .pp-table thead {
                background-color: #f1f3f5;
            }

            /* 상태별 뱃지 스타일 */
            .status-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }
            .status-active { background-color: #e6fcf5; color: #0ca678; }
            .status-dormant { background-color: #fff9db; color: #f59f00; }
            .status-withdrawn { background-color: #f1f3f5; color: #868e96; }
            .status-banned { background-color: #fff5f5; color: #fa5252; }

            /* ===== MODAL ===== */
            .pp-modal-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.45);
                justify-content: center;
                align-items: center;
                z-index: 2000;
            }

            .pp-modal-backdrop.pp-show {
                display: flex;
            }

            .pp-modal {
                background: #fff;
                border-radius: 8px;
                width: 400px;
                padding: 20px 24px;
                box-shadow: 0 20px 35px rgba(15, 23, 42, 0.35);
            }

            .pp-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
            }

            .pp-modal-title { font-size: 18px; font-weight: 600; }

            .pp-form-group { margin-bottom: 16px; }
            .pp-form-group label { font-size: 14px; font-weight: 500; margin-bottom: 6px; display: block; }
            .pp-form-group select, .pp-form-group input { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; }
            .pp-form-group input[readonly] { background-color: #f8f9fa; color: #666; }

            .pp-modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }

            /* ===== PAGINATION ===== */
            .pagination-container { margin-top: 20px; display: flex; justify-content: center; }
            .pagination { list-style: none; display: flex; padding: 0; margin: 0; }
            .page-item { margin: 0 2px; }
            .page-link {
                display: block; padding: 6px 12px; border: 1px solid #dee2e6;
                color: #333; text-decoration: none; border-radius: 4px; font-size: 14px;
            }
            .page-item.active .page-link { background-color: #0064FF; color: #fff; border-color: #0064FF; }
            .page-item.disabled .page-link { color: #ccc; pointer-events: none; }

        </style>
    </th:block>
</head>

<body>
<section layout:fragment="hero" class="hero" style="display:none;"></section>

<div layout:fragment="content">
    <section class="product spad">
        <div class="container">
            <div class="row">

                <div class="col-lg-3">
                    <div class="hero__categories">
                        <div class="hero__categories__all">
                            <i class="fa fa-bars"></i>
                            <span>관리자 메뉴</span>
                        </div>
                        <ul th:replace="~{fragment/admin-sidebar :: sidebar}">
                        </ul>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="pp-page-container">

                        <div class="pp-page-header">
                            <h4 class="pp-page-title">
                                <i class="fa fa-users" style="color:#0064FF;margin-right:6px;"></i>
                                회원 관리
                            </h4>
                        </div>

                        <table class="pp-table">
                            <colgroup>
                                <col style="width: 50px;"> <col style="width: 100px;"> <col style="width: 80px;"> <col style="width: 160px;"> <col style="width: 120px;"> <col style="width: 100px;"> <col style="width: 80px;"> </colgroup>
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>아이디</th>
                                <th>이름</th>
                                <th>이메일</th>
                                <th>전화번호</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${members.content.isEmpty()}">
                                <td colspan="7" class="text-center" style="padding:30px;">
                                    등록된 회원이 없습니다.
                                </td>
                            </tr>

                            <tr th:each="m : ${members.content}">
                                <td th:text="${m.id}"></td>
                                <td th:text="${m.username}"></td>
                                <td th:text="${m.name}"></td>
                                <td th:text="${m.email}" title="${m.email}"></td> <td th:text="${m.phone}"></td>

                                <td>
                                    <span class="status-badge"
                                          th:classappend="${m.status == 'NORMAL' ? 'status-normal' :
                                                           (m.status == 'DORMANT' ? 'status-dormant' :
                                                           (m.status == 'WITHDRAWN' ? 'status-withdrawn' : 'status-banned'))}"
                                          th:text="${m.status}">
                                    </span>
                                </td>

                                <td>
                                    <button class="pp-btn pp-btn-primary pp-btn-open-status-modal"
                                            style="padding: 4px 10px; font-size: 12px;"
                                            th:attr="data-id=${m.id},
                                                     data-username=${m.username},
                                                     data-status=${m.status}">
                                        수정
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <div class="pagination-container" th:if="${!members.content.isEmpty()}">
                            <ul class="pagination">
                                <li class="page-item" th:classappend="${members.first} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/members(page=${members.number - 1})}">&laquo;</a>
                                </li>

                                <li class="page-item"
                                    th:each="page : ${#numbers.sequence(0, members.totalPages - 1)}"
                                    th:if="${page >= members.number - 2 and page <= members.number + 2}"
                                    th:classappend="${page == members.number} ? 'active'">
                                    <a class="page-link" th:text="${page + 1}" th:href="@{/admin/members(page=${page})}">1</a>
                                </li>

                                <li class="page-item" th:classappend="${members.last} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/members(page=${members.number + 1})}">&raquo;</a>
                                </li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="pp-modal-backdrop" id="status-modal">
        <div class="pp-modal">
            <div class="pp-modal-header">
                <div class="pp-modal-title">회원 상태 변경</div>
                <button class="pp-btn" id="btn-close-status-modal" style="border:none; background:none; font-size:18px;">X</button>
            </div>

            <div class="pp-modal-body">
                <form id="status-form">
                    <input type="hidden" id="modal-member-id">

                    <div class="pp-form-group">
                        <label>회원 아이디</label>
                        <input type="text" id="modal-member-username" readonly>
                    </div>

                    <div class="pp-form-group">
                        <label>상태 선택</label>
                        <select id="modal-member-status" required>
                            <option value="NORMAL">일반 (ACTIVE)</option>
                            <option value="DORMANT">휴면 (DORMANT)</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="pp-modal-footer">
                <button class="pp-btn" id="btn-cancel-status">취소</button>
                <button class="pp-btn pp-btn-primary" id="btn-submit-status">저장</button>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="extra-js">
    <script>
        (function() {

            /* CSRF 설정 (Spring Security 사용 시 필요) */
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            function headers() {
                const h = { "Content-Type": "application/json" };
                if (csrfToken && csrfHeader) h[csrfHeader] = csrfToken;
                return h;
            }

            /* === STATUS MODAL === */
            const statusModal = document.getElementById("status-modal");

            // 모달 열기 버튼 클릭 이벤트
            document.querySelectorAll(".pp-btn-open-status-modal")
                .forEach(btn => {
                    btn.addEventListener("click", () => {
                        // 데이터 바인딩
                        document.getElementById("modal-member-id").value = btn.dataset.id;
                        document.getElementById("modal-member-username").value = btn.dataset.username;
                        document.getElementById("modal-member-status").value = btn.dataset.status;

                        // 모달 표시
                        statusModal.classList.add("pp-show");
                    });
                });

            // 모달 닫기 (X 버튼)
            document.getElementById("btn-close-status-modal")
                .addEventListener("click", () => statusModal.classList.remove("pp-show"));

            // 모달 닫기 (취소 버튼)
            document.getElementById("btn-cancel-status")
                .addEventListener("click", () => statusModal.classList.remove("pp-show"));

            // 저장 버튼 클릭 (AJAX 요청)
            document.getElementById("btn-submit-status")
                .addEventListener("click", () => {
                    const id = document.getElementById("modal-member-id").value;
                    const status = document.getElementById("modal-member-status").value;

                    fetch(`/admin/members/${id}/status`, {
                        method: "PUT",
                        headers: headers(),
                        body: JSON.stringify({ status: status })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert("회원 상태가 변경되었습니다.");
                                location.reload();
                            } else {
                                alert("상태 변경 실패");
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("서버 통신 오류");
                        });
                });

        })();
    </script>

    <script>
        $(document).ready(function() {
            $('.admin-category-header').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var menuId = $(this).data('admin-menu');
                $('#admin-menu-' + menuId).slideToggle(300);
                $(this).find('.admin-toggle').toggleClass('active');
            });
        });
    </script>
</div>

</body>
</html>