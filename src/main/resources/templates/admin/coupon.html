<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <meta charset="UTF-8">
    <title>쿠폰 관리 | 북스캠프 관리자</title>

    <th:block layout:fragment="extra-css">
        <style>
            .btn-add-child {
                background: #7fad39;
                color: white;
                padding: 5px 12px;
                border-radius: 4px;
                text-decoration: none;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
            }
            .btn-add-child:hover { background: #6d9631; }

            .btn-delete {
                background: #dc3545;
                color: white;
                padding: 5px 12px;
                border-radius: 4px;
                text-decoration: none;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
            }
            .btn-delete:hover { background: #c82333; }

            #add-coupon-form-container {
                font-size: 14px;
                margin-bottom: 25px;
                padding: 25px;
                background: #f9f9f9;
                border-radius: 4px;
                border: 1px solid #eee;
            }
            #add-coupon-form-container .form-label {
                font-weight: 500;
                margin-bottom: 5px;
            }
            .form-control, .form-select {
                font-size: 14px;
                padding: 8px 12px;
            }

            .target-id-group {
                display: none;
            }

            /* --- [추가] 모달 및 트리 스타일 --- */
            .scrollable-list {
                max-height: 400px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 4px;
                background: white;
            }

            /* 카테고리 트리 스타일 */
            .category-tree ul {
                list-style-type: none;
                padding-left: 20px;
            }
            .category-tree li {
                margin: 5px 0;
            }
            .category-node {
                cursor: pointer;
                padding: 4px 8px;
                border-radius: 4px;
                display: inline-block;
                transition: background 0.2s;
            }
            .category-node:hover {
                background-color: #e0e0e0;
                color: #7fad39;
                font-weight: bold;
            }
            .category-node i {
                margin-right: 5px;
            }
        </style>
    </th:block>
</head>

<body>
<section layout:fragment="hero" class="hero" style="display: none;"></section>

<div layout:fragment="content">
    <section class="product spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="hero__categories">
                        <div class="hero__categories__all">
                            <i class="fa fa-bars"></i>
                            <span>관리자 메뉴</span>
                        </div>
                        <ul th:replace="~{fragment/admin-sidebar :: sidebar}">
                            <li><a href="#">메뉴</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div style="background: #ffffff; padding: 30px; border: 1px solid #ebebeb; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h4 style="margin: 0; font-weight: 700;">
                                <i class="fa fa-ticket" style="margin-right: 10px; color: #0064FF;"></i>
                                쿠폰 관리
                            </h4>
                            <a href="#" class="btn-add-child" style="padding: 8px 16px; font-size: 14px;"
                               onclick="toggleAddForm(this); return false;">
                                <i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록
                            </a>
                        </div>

                        <div id="add-coupon-form-container" style="display: none;">
                            <h5 style="font-weight: 600; margin-bottom: 20px;">새 쿠폰 정보 입력</h5>
                            <form id="add-coupon-form" onsubmit="submitAddCoupon(this); return false;">

                                <div class="mb-3">
                                    <label for="name" class="form-label">쿠폰 이름 (*)</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="targetType" class="form-label">적용 대상 (*)</label>
                                        <select class="form-select" id="targetType" name="targetType" required onchange="onTargetTypeChange(this.value)">
                                            <option value="CATEGORY">카테고리</option>
                                            <option value="BOOK">도서</option>
                                            <option value="WELCOME">신규가입</option>
                                            <option value="BIRTHDAY">생일</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6 mb-3 target-id-group">
                                        <label class="form-label">대상 선택 (*)</label>
                                        <div class="input-group">
                                            <input type="hidden" id="targetId" name="targetId">

                                            <input type="text" class="form-control" id="targetName" placeholder="대상을 검색하세요" readonly style="background-color: #fff;">

                                            <button class="btn btn-outline-secondary" type="button" onclick="openTargetModal()">
                                                <i class="fa fa-search"></i> 검색
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="discountType" class="form-label">할인 유형 (*)</label>
                                        <select class="form-select" id="discountType" name="discountType" required>
                                            <option value="AMOUNT">정액 할인 (원)</option>
                                            <option value="RATE">정률 할인 (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="discountValue" class="form-label">할인 값 (*)</label>
                                        <input type="number" class="form-control" id="discountValue" name="discountValue" placeholder="정액: 1000 (원), 정률: 10 (%)" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="minOrderAmount" class="form-label">최소 주문 금액 (원) (*)</label>
                                        <input type="number" class="form-control" id="minOrderAmount" name="minOrderAmount" value="0" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="maxDiscountAmount" class="form-label">최대 할인 금액 (원)</label>
                                        <input type="number" class="form-control" id="maxDiscountAmount" name="maxDiscountAmount" placeholder="정률 할인 시 입력 (선택)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="validDays" class="form-label">유효 기간 (일)</label>
                                        <input type="number" class="form-control" id="validDays" name="validDays" placeholder="발급일로부터 유효한 일수 (예: 30)">
                                    </div>
                                </div>
                                <div class="text-end" style="margin-top: 10px;">
                                    <button type="button" class="btn btn-secondary" style="font-size: 14px; padding: 6px 14px;" onclick="toggleAddForm(null);">취소</button>
                                    <button type="submit" class="btn-add-child" style="border:none; font-size: 14px; padding: 7px 14px;">쿠폰 생성</button>
                                </div>
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>쿠폰 이름</th>
                                    <th>적용 대상</th>
                                    <th>대상 ID</th>
                                    <th>할인</th>
                                    <th>최소 주문</th>
                                    <th>최대 할인</th>
                                    <th>유효일</th>
                                    <th>관리</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="coupon : ${coupons}" th:id="'coupon-row-' + ${coupon.id}">
                                    <td th:text="${coupon.id}">1</td>
                                    <td th:text="${coupon.name}">신규가입 쿠폰</td>
                                    <td th:text="${coupon.targetType}">WELCOME</td>
                                    <td th:text="${coupon.targetId}">-</td>
                                    <td th:text="${coupon.discountType.toString() == 'RATE'} ? ${coupon.discountValue} + '%' : ${#numbers.formatDecimal(coupon.discountValue, 0, 'COMMA', 0, 'POINT')} + '원'">
                                        10%
                                    </td>
                                    <td th:text="${#numbers.formatDecimal(coupon.minOrderAmount, 0, 'COMMA', 0, 'POINT')} + '원'">
                                        10,000원
                                    </td>
                                    <td th:text="${coupon.maxDiscountAmount != null} ? ${#numbers.formatDecimal(coupon.maxDiscountAmount, 0, 'COMMA', 0, 'POINT')} + '원' : '-'">
                                        5,000원
                                    </td>
                                    <td th:text="${coupon.validDays != null} ? ${coupon.validDays} + '일' : '-'">30일</td>
                                    <td>
                                        <button class="btn-delete" style="border:none; cursor:pointer;"
                                                th:onclick="'submitDelete(this, ' + ${coupon.id} + ');'">삭제</button>
                                    </td>
                                </tr>
                                <tr th:if="${coupons == null or #lists.isEmpty(coupons)}">
                                    <td colspan="9" class="text-center" style="padding: 30px;">
                                        등록된 쿠폰이 없습니다.
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="categorySelectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">카테고리 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div id="categoryTreeContainer" class="scrollable-list category-tree">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookSearchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">도서 검색</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="input-group mb-3">
                        <input type="text" id="bookSearchInput" class="form-control" placeholder="도서 제목을 입력하세요">
                        <button class="btn btn-outline-primary" type="button" onclick="searchBooks()">검색</button>
                    </div>
                    <div id="bookListContainer" class="scrollable-list">
                        <div class="text-center text-muted p-3">검색어를 입력하고 검색 버튼을 눌러주세요.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="extra-js">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        let csrfToken = null;
        let csrfHeader = null;
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        if (csrfTokenMeta && csrfHeaderMeta) {
            csrfToken = csrfTokenMeta.content;
            csrfHeader = csrfHeaderMeta.content;
        }

        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        // --------------------------------------------------------------------------------
        // [핵심] 1. 서버(Advice)에서 내려온 카테고리 데이터를 JS 변수에 바로 담기
        // --------------------------------------------------------------------------------
        const globalCategories = /*[[${categories}]]*/ [];

        // 모달 인스턴스 변수
        let categoryModal = null;
        let bookModal = null;


        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 부트스트랩 모달 초기화
            categoryModal = new bootstrap.Modal(document.getElementById('categorySelectModal'));
            bookModal = new bootstrap.Modal(document.getElementById('bookSearchModal'));

            onTargetTypeChange(document.getElementById('targetType').value);
        });


        // --------------------------------------------------------------------------------
        // [핵심] 2. 카테고리 트리 그리기 함수 (fetch 없이 변수 데이터 사용)
        // --------------------------------------------------------------------------------
        function renderCategoryTree() {
            const container = document.getElementById('categoryTreeContainer');

            // 데이터가 없으면 안내 문구
            if (!globalCategories || globalCategories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">등록된 카테고리가 없습니다.</div>';
                return;
            }

            // 재귀적으로 HTML 생성
            function buildHtml(cats) {
                if (!cats || cats.length === 0) return '';
                let html = '<ul>';

                cats.forEach(c => {
                    const hasChildren = c.children && c.children.length > 0;
                    // 이름에 따옴표가 있을 경우를 대비한 이스케이프
                    const safeName = c.name.replace(/'/g, "\\'");

                    html += `
                        <li>
                            <span class="category-node" onclick="selectTarget(${c.id}, '${safeName}')">
                                <i class="fa ${hasChildren ? 'fa-folder' : 'fa-file-o'}" style="color: ${hasChildren ? '#FFB400' : '#7fad39'};"></i>
                                ${c.name}
                            </span>
                            ${hasChildren ? buildHtml(c.children) : ''}
                        </li>
                    `;
                });

                html += '</ul>';
                return html;
            }

            container.innerHTML = buildHtml(globalCategories);
        }


        // --------------------------------------------------------------------------------
        // 3. UI 제어 및 이벤트 핸들러
        // --------------------------------------------------------------------------------

        function toggleAddForm(button) {
            const container = document.getElementById('add-coupon-form-container');
            const isVisible = container.style.display === 'block';
            container.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                onTargetTypeChange(document.getElementById('targetType').value);
            }

            if (button) {
                if (isVisible) {
                    button.innerHTML = '<i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록';
                } else {
                    button.innerHTML = '<i class="fa fa-times" style="margin-right: 5px;"></i>등록 취소';
                    document.getElementById('add-coupon-form').reset();

                    // 리셋 시 hidden 및 표시용 input도 초기화
                    document.getElementById('targetId').value = '';
                    document.getElementById('targetName').value = '';

                    document.getElementById('name').focus();
                    onTargetTypeChange(document.getElementById('targetType').value);
                }
            } else if (isVisible) {
                const mainButton = document.querySelector('a[onclick^="toggleAddForm"]');
                if(mainButton) {
                    mainButton.innerHTML = '<i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록';
                }
            }
        }

        function onTargetTypeChange(targetType) {
            const targetIdGroup = document.querySelector('.target-id-group');
            // 타입 변경 시 기존 선택 값 초기화
            document.getElementById('targetId').value = '';
            document.getElementById('targetName').value = '';

            if (targetType === 'CATEGORY' || targetType === 'BOOK') {
                targetIdGroup.style.display = 'block';
            } else {
                targetIdGroup.style.display = 'none';
            }
        }

        // "검색" 버튼 클릭 시
        function openTargetModal() {
            const targetType = document.getElementById('targetType').value;

            if (targetType === 'CATEGORY') {
                // 이미 로드된 데이터를 렌더링하고 모달 띄우기 (API 호출 X)
                renderCategoryTree();
                categoryModal.show();
            } else if (targetType === 'BOOK') {
                // 도서는 데이터가 많으므로 필요할 때 검색 (별도 로직 필요)
                document.getElementById('bookSearchInput').value = '';
                document.getElementById('bookListContainer').innerHTML = '<div class="text-center text-muted p-3">검색어를 입력하세요.</div>';
                bookModal.show();
            } else {
                alert('카테고리 또는 도서를 선택해야 검색할 수 있습니다.');
            }
        }

        // 모달 리스트에서 항목 클릭 시 폼에 입력
        function selectTarget(id, name) {
            document.getElementById('targetId').value = id;
            document.getElementById('targetName').value = name;

            // 열려있는 모달 닫기
            categoryModal.hide();
            bookModal.hide();
        }

        // (참고용) 도서 검색 함수 - 실제 API 필요
        async function searchBooks() {
            const keyword = document.getElementById('bookSearchInput').value;
            if(!keyword) return alert('검색어를 입력하세요');

            // 이곳은 별도의 도서 검색 API가 필요하므로 틀만 유지
            const container = document.getElementById('bookListContainer');
            container.innerHTML = '<div class="text-center p-3">도서 검색 API 연동 필요...</div>';
        }


        async function submitAddCoupon(form) {
            if (!confirm('새 쿠폰을 생성하시겠습니까?')) {
                return;
            }

            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (value) {
                    data[key] = value;
                }
            });

            // 검증: ID 필수 체크
            if ((data.targetType === 'CATEGORY' || data.targetType === 'BOOK') && !data.targetId) {
                alert('적용 대상(카테고리/도서)을 검색하여 선택해주세요.');
                return;
            }

            data.discountValue = parseInt(data.discountValue);
            data.minOrderAmount = parseInt(data.minOrderAmount);

            if (data.targetId) {
                data.targetId = parseInt(data.targetId);
            } else {
                data.targetId = null;
            }

            if (data.maxDiscountAmount) {
                data.maxDiscountAmount = parseInt(data.maxDiscountAmount);
            } else {
                data.maxDiscountAmount = null;
            }

            if (data.validDays) {
                data.validDays = parseInt(data.validDays);
            } else {
                data.validDays = null;
            }

            // API 호출 (프론트 서버 -> 백엔드)
            const apiUrl = '/api-server/admin/coupons';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (!response.ok) {
                    let errorMsg = '쿠폰 생성에 실패했습니다.';
                    try {
                        const errorData = await response.json();
                        errorMsg += `\n${errorData.message || '서버 오류'}`;
                    } catch(e) {}
                    throw new Error(errorMsg);
                }

                alert('쿠폰이 성공적으로 생성되었습니다.');
                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        async function submitDelete(buttonElement, couponId) {
            if (!confirm(`[ID: ${couponId}] 쿠폰을 정말 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.`)) {
                return;
            }

            const apiUrl = '/api-server/admin/coupons';

            try {
                const response = await fetch(`${apiUrl}/${couponId}`, {
                    method: 'POST', // DELETE 메서드 지원 여부에 따라 조정
                    headers: headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('쿠폰 삭제에 실패했습니다.');
                }

                alert('쿠폰이 삭제되었습니다.');
                const row = document.getElementById('coupon-row-' + couponId);
                if (row) {
                    row.remove();
                } else {
                    location.reload();
                }

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            onTargetTypeChange(document.getElementById('targetType').value);
        });

        /*]]>*/
    </script>

    <script>
        $(document).ready(function() {
            $('.admin-category-header').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                var menuId = $(this).data('admin-menu');
                var $submenu = $('#admin-menu-' + menuId);
                var $toggle = $(this).find('.admin-toggle');

                $toggle.toggleClass('active');
                $submenu.slideToggle(300);
            });

            $('.admin-toggle').attr('role', 'button');
            $('.admin-toggle').attr('aria-expanded', 'false');
            $('.admin-toggle').attr('tabindex', '0');
        });
    </script>
</div>
</body>
</html>