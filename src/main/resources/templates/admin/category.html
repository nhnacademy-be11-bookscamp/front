<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/default}">

<head>
    <meta charset="UTF-8">
    <title>Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨</title>

    <th:block layout:fragment="extra-css">
        <style>
            .category-list, .category-list-child {
                list-style: none;
                padding-left: 15px;
            }

            .category-item {
                padding: 6px 5px;
            }

            .category-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0;
            }

            .category-label {
                display: flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
            }

            .category-children {
                margin-left: 20px;
                display: none;
            }

            .expanded > .category-children {
                display: block;
            }

            .category-buttons {
                display: flex;
                gap: 6px;
            }

            .category-buttons a, .category-buttons button {
                font-size: 0.8rem;
                padding: 2px 6px;
                border-radius: 4px;
                text-decoration: none;
            }

            .btn-add-child { background: #e0f7fa; color: #00796b; }
            .btn-edit { background: #e0e0e0; color: #444; }
            .btn-delete { background: #ffebee; color: #c62828; }
        </style>
    </th:block>

    <script>
        function toggleCategory(element) {
            const item = element.closest(".category-item");
            if (item) {
                item.classList.toggle("expanded");
            }
        }

        function showEditForm(buttonElement, categoryId, currentName) {
            const row = buttonElement.closest('.category-row');
            if (!row) return;

            const existingForm = row.parentElement.querySelector('.edit-form');
            if (existingForm) {
                cancelEdit(existingForm.querySelector('button'), row.id);
            }

            row.style.display = 'none';

            const formHtml = `
                <form class="category-row edit-form" onsubmit="submitEditForm(this, ${categoryId}); return false;">
                    <input type="text" name="name" value="${currentName}" style="flex-grow: 1;" required>
                    <span class="category-buttons">
                        <button type="submit" class="btn-edit" style="border:none; cursor:pointer;">Ï†ÄÏû•</button>
                        <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                onclick="cancelEdit(this, '${row.id}');">Ï∑®ÏÜå</button>
                    </span>
                </form>
            `;
            row.insertAdjacentHTML('afterend', formHtml);
            row.parentElement.querySelector('.edit-form input').focus();
        }

        function cancelEdit(cancelButton, originalRowId) {
            const form = cancelButton.closest('.edit-form');
            if (form) {
                form.remove();
            }
            const originalRow = document.getElementById(originalRowId);
            if (originalRow) {
                originalRow.style.display = 'flex';
            }
        }

        function showRootAddForm() {
            const rootList = document.querySelector('.category-list');
            if (!rootList) return;

            if (rootList.querySelector('.add-form-li')) {
                rootList.querySelector('.add-form-li input[name="name"]').focus();
                return;
            }

            const formHtml = `
                <li class="category-item add-form-li" style="padding-left: 0;">
                    <form class="category-row add-form" onsubmit="submitAddForm(this, null); return false;">
                        <input type="text" name="name" placeholder="ÏÉà ÏµúÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ" style="flex-grow: 1;" required>
                        <span class="category-buttons">
                            <button type="submit" class="btn-add-child" style="border:none; cursor:pointer;">Îì±Î°ù</button>
                            <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                    onclick="this.closest('.add-form-li').remove();">Ï∑®ÏÜå</button>
                        </span>
                    </form>
                </li>
            `;
            rootList.insertAdjacentHTML('beforeend', formHtml);
            rootList.querySelector('.add-form-li input[name="name"]').focus();
        }

        function showAddForm(buttonElement, parentId) {
            const parentItem = buttonElement.closest('.category-item');
            if (!parentItem) return;

            const childrenList = parentItem.querySelector('.category-children');
            if (!childrenList) return;

            if (childrenList.querySelector('.add-form-li')) {
                childrenList.querySelector('.add-form-li input[name="name"]').focus();
                return;
            }

            const formHtml = `
                <li class="category-item add-form-li">
                    <form class="category-row add-form" onsubmit="submitAddForm(this, ${parentId}); return false;">
                        <input type="text" name="name" placeholder="ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ" style="flex-grow: 1;" required>
                        <span class="category-buttons">
                            <button type="submit" class="btn-add-child" style="border:none; cursor:pointer;">Îì±Î°ù</button>
                            <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                    onclick="this.closest('.add-form-li').remove();">Ï∑®ÏÜå</button>
                        </span>
                    </form>
                </li>
            `;

            childrenList.insertAdjacentHTML('afterbegin', formHtml);

            parentItem.classList.add('expanded');
            childrenList.style.display = 'block';

            childrenList.querySelector('.add-form-li input[name="name"]').focus();
        }
    </script>

    <script th:inline="javascript">
        const pathPrefix = /*[[${apiPrefix}]]*/ '';
        /*<![CDATA[*/

        let csrfToken = null;
        let csrfHeader = null;

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        if (csrfTokenMeta && csrfHeaderMeta) {
            csrfToken = csrfTokenMeta.content;
            csrfHeader = csrfHeaderMeta.content;
        }

        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        async function submitEditForm(form, categoryId) {
            const newName = form.querySelector('input[name="name"]').value;

            const apiUrl = pathPrefix + '/api-server/admin/category/update';
            console.log(apiUrl);

            try {
                const response = await fetch(`${apiUrl}/${categoryId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ name: newName })
                });

                if (!response.ok) {
                    throw new Error('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        async function submitAddForm(form, parentId) {

            const newName = form.querySelector('input[name="name"]').value;

            const apiUrl = pathPrefix + '/api-server/admin/category/create';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ parentId: parentId, name: newName })
                });

                if (!response.ok) {
                    throw new Error('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // *** [ÏàòÏ†ïÎê®] ÏÇ≠Ï†úÎ•º ÏúÑÌïú AJAX Ìï®Ïàò Ï∂îÍ∞Ä ***
        async function submitDelete(buttonElement, categoryId) {
            // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ìïú Î≤à Îçî ÌôïÏù∏
            if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?')) {
                return;
            }

            // Îã§Î•∏ API Í≤ΩÎ°úÎ•º Ï∞∏Í≥†ÌïòÏó¨ ÏÇ≠Ï†ú API Í≤ΩÎ°ú ÏÑ§Ï†ï
            const apiUrl = pathPrefix + '/api-server/admin/category/delete';

            try {
                const response = await fetch(`${apiUrl}/${categoryId}`, {
                    method: 'DELETE',
                    headers: headers // CSRF ÌÜ†ÌÅ∞ Îì±Ïù¥ Ìè¨Ìï®Îêú Ìó§Îçî
                });

                if (!response.ok) {
                    // ÏÑúÎ≤ÑÏóêÏÑú Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄÎ•º Î≥¥ÎÉàÏùÑ Í≤ΩÏö∞
                    // const errorData = await response.json();
                    // throw new Error(errorData.message || 'Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');

                    // Í∞ÑÎã®Ìïú ÏóêÎü¨ Ï≤òÎ¶¨
                    throw new Error('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                // ÏÑ±Í≥µ Ïãú ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }
        /*]]>*/
    </script>
</head>

<body>
<div layout:fragment="content">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="font-size: 1.8rem; font-weight: 600;">Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù</h1>

        <a href="#" class="btn-add-child" style="padding: 8px 12px;"
           onclick="showRootAddForm(); return false;">
            + ÏÉà Î™©Î°ù Ï∂îÍ∞Ä
        </a>
    </div>

    <ul class="category-list">
        <th:block th:each="category : ${categories}">
            <th:block th:replace="~{this :: categoryItem(category=${category})}"></th:block>
        </th:block>
    </ul>

    <th:block th:fragment="categoryItem(category)">
        <li class="category-item" th:id="'category-item-' + ${category.id}">

            <div class="category-row" th:id="'category-row-' + ${category.id}">
                <span class="category-label" onclick="toggleCategory(this)">
                    <span th:text="${(category.children != null and !category.children.isEmpty()) ? 'üìÅ' : ''}"></span>
                    <span class="category-name" th:text="${category.name}">Ïπ¥ÌÖåÍ≥†Î¶¨</span>
                </span>

                <span class="category-buttons">
                    <a href="#" class="btn-add-child"
                       th:onclick="showAddForm(this, [[${category.id}]]); return false;">Ï∂îÍ∞Ä</a>
                    <a href="#" class="btn-edit"
                       th:onclick="showEditForm(this, [[${category.id}]], [[${category.name}]]); return false;">ÏàòÏ†ï</a>

                    <a href="#" class="btn-delete"
                       th:onclick="submitDelete(this, [[${category.id}]]); return false;">ÏÇ≠Ï†ú</a>
                </span>
            </div>

            <ul th:if="${category.children != null and !category.children.isEmpty()}" class="category-children">
                <th:block th:each="child : ${category.children}">
                    <th:block th:replace="~{this :: categoryItem(category=${child})}"></th:block>
                </th:block>
            </ul>

            <ul th:unless="${category.children != null and !category.children.isEmpty()}" class="category-children" style="display: none;">
            </ul>

        </li>
    </th:block>

</div>
</body>
</html>