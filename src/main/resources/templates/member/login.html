<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/no-sidebar}">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
    <style>
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1>로그인</h1>

    <div style="margin-top: 2rem;">
        <form id="loginForm">
            <div>
                <label for="username">아이디</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div>
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" id="loginButton">로그인</button>

            <div id="loginMessage" class="error" style="margin-top: 10px;"></div>
        </form>

    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            var pathPrefix = /*[[${apiPrefix}]]*/ '';

            var loginForm = document.getElementById('loginForm');
            var loginButton = document.getElementById('loginButton');
            var loginMessage = document.getElementById('loginMessage');
            var usernameInput = document.getElementById('username');
            var passwordInput = document.getElementById('password');

            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                var username = usernameInput.value;
                var password = passwordInput.value;

                const url = pathPrefix + '/auth-server/login';

                loginMessage.textContent = '로그인 시도 중...';
                loginMessage.classList.remove('error', 'success');
                loginButton.disabled = true;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    if (response.ok) {
                        const data = await response.text();
                        console.log('로그인 성공 응답:', data);

                        loginMessage.textContent = '로그인에 성공했습니다. 메인 페이지로 이동합니다.';
                        loginMessage.classList.remove('error');
                        loginMessage.classList.add('success');

                        window.location.href = '/';

                    } else {
                        const errorText = await response.text();
                        console.error('로그인 실패 응답:', response.status, errorText);

                        let message = "로그인에 실패했습니다. 아이디와 비밀번호를 다시 확인해주세요.";

                        if (response.status === 401) {
                            message = "인증 정보가 올바르지 않습니다.";
                        }

                        loginMessage.textContent = message;
                        loginMessage.classList.remove('success');
                        loginMessage.classList.add('error');
                    }

                } catch (error) {

                    console.error('Network Fetch Error:', error);
                    loginMessage.textContent = "네트워크 연결에 문제가 발생했습니다. 잠시 후 다시 시도해 주세요.";
                    loginMessage.classList.remove('success');
                    loginMessage.classList.add('error');
                } finally {
                    loginButton.disabled = false;
                    passwordInput.value = '';
                }
            });
        });
    </script>
</div>
</body>
</html>