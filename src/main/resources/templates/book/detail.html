<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${book.title} + ' | ë¶ìŠ¤ìº í”„'">ë„ì„œ ìƒì„¸</title>
</head>

<body>
<section layout:fragment="hero" class="hero" style="display: none;">
</section>

<div layout:fragment="content">
    <section class="product-details spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__pic">

                        <div th:if="${book.imageUrlList != null and !book.imageUrlList.isEmpty()}"
                             class="swiper product-swiper-container">
                            <div class="swiper-wrapper">
                                <div th:each="url : ${book.imageUrlList}" class="swiper-slide">
                                    <img th:src="${url}" alt="Book Cover">
                                </div>
                            </div>
                            <div class="swiper-pagination"></div>
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-button-next"></div>
                        </div>

                        <div th:if="${book.imageUrlList == null or book.imageUrlList.isEmpty()}" class="product__details__pic__item">
                            <div style="width: 100%; height: 500px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; border: 1px solid #ebebeb; border-radius: 4px;">
                                <i class="fa fa-book" style="font-size: 80px; color: #ccc;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 col-md-6">
                    <div class="product__details__text">
                        <h3 th:text="${book.title}" style="margin-bottom: 20px; font-weight: 700; color: #333;">ë„ì„œ ì œëª©</h3>

                        <div style="padding: 20px 0; border-top: 1px solid #ebebeb; border-bottom: 1px solid #ebebeb; margin-bottom: 20px;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; display: flex;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">ì¶œíŒì‚¬</span>
                                    <span th:text="${book.publisher}" style="color: #333;">ì¶œíŒì‚¬</span>
                                </li>
                                <li style="padding: 8px 0; display: flex;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">ì¶œíŒì¼</span>
                                    <span th:text="${#temporals.format(book.publishDate, 'yyyy-MM-dd')}" style="color: #333;">2025-01-01</span>
                                </li>
                                <li style="padding: 8px 0; display: flex;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">ì¬ê³ </span>
                                    <span style="color: #333;">
                                        <span th:text="${book.stock + 'ê¶Œ'}">10ê¶Œ</span>

                                        <th:block th:if="${book.status.name() == 'DISCONTINUED'}">
                                            <span style="margin-left: 10px; color: #999; font-weight: 700; border: 1px solid #ccc; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                                                íŒë§¤ì¤‘ì§€
                                            </span>
                                        </th:block>

                                        <th:block th:unless="${book.status.name() == 'DISCONTINUED'}">
                                            <span th:if="${book.stock == 0}" style="margin-left: 10px; color: #dc3545; font-weight: 600;">í’ˆì ˆ</span>
                                            <span th:if="${book.stock > 0 and book.stock <= 10}" style="margin-left: 10px; color: #ff9800; font-weight: 600;">í’ˆì ˆì„ë°•</span>
                                        </th:block>
                                    </span>
                                </li>
                                <li style="padding: 8px 0; display: flex;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">í¬ì¥</span>
                                    <span th:if="${book.packable}" style="color: #7fad39; font-weight: 600;">í¬ì¥ ê°€ëŠ¥</span>
                                    <span th:unless="${book.packable}" style="color: #999;">í¬ì¥ ë¶ˆê°€ëŠ¥</span>
                                </li>
                                <li style="padding: 8px 0; display: flex;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">ì¡°íšŒìˆ˜</span>
                                    <span th:text="${book.viewCount}" style="color: #333;">200</span>
                                </li>

                                <li style="padding: 8px 0; display: flex; align-items: flex-start;">
                                    <span style="width: 100px; color: #6f6f6f; font-weight: 600;">ì¹´í…Œê³ ë¦¬</span>
                                    <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 6px;">
                                        <span th:each="category : ${book.categoryList}"
                                              th:text="${category.name}"
                                              style="background: #f2f2f2; color: #6f6f6f; padding: 3px 10px; border-radius: 12px; font-size: 13px;">
                                            ì¹´í…Œê³ ë¦¬ëª…
                                        </span>
                                        <span th:if="${#lists.isEmpty(book.categoryList)}" style="color: #999;">
                                            ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                                        </span>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <div class="product__details__tags" style="margin-bottom: 20px;">
                            <div th:if="${!#lists.isEmpty(book.tagList)}" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                <i class="fa fa-tags" style="color: #6f6f6f; margin-right: 5px;"></i>
                                <a th:each="tag : ${book.tagList}"
                                   th:href="@{/search(query=${tag.name})}"
                                   th:text="'#' + ${tag.name}"
                                   style="color: #7fad39; font-size: 14px; font-weight: 600; text-decoration: none; background: #eef7e4; padding: 4px 10px; border-radius: 4px;">
                                    #íƒœê·¸ëª…
                                </a>
                            </div>
                        </div>
                        <div class="product__details__price" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 10px;">
                                <span style="text-decoration: line-through; color: #999; font-size: 18px;"
                                      th:text="${#numbers.formatInteger(book.regularPrice, 0, 'COMMA') + 'ì›'}">15,000ì›</span>
                            </div>
                            <div style="display: flex; align-items: baseline;">
                                <span style="font-size: 32px; font-weight: 700; color: #7fad39;"
                                      th:text="${#numbers.formatInteger(book.salePrice, 0, 'COMMA') + 'ì›'}">12,000ì›</span>
                                <span th:if="${book.regularPrice > book.salePrice}"
                                      style="margin-left: 15px; font-size: 24px; font-weight: 700; color: #dc3545;"
                                      th:text="${#numbers.formatDecimal((book.regularPrice - book.salePrice) * 100.0 / book.regularPrice, 0, 0) + '%'}">20%</span>
                            </div>
                        </div>

                        <div id="coupon-section-container" style="margin-bottom: 20px; display: none; border: 1px dashed #7fad39; border-radius: 4px;">
                            <div id="coupon-trigger-banner" style="padding: 15px 20px; background: #f8fcf3; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: #7fad39;">
                                    <i class="fa fa-gift" style="margin-right: 8px;"></i>
                                    ë°œê¸‰ ê°€ëŠ¥í•œ ì¿ í°ì´ ìˆìŠµë‹ˆë‹¤!
                                </span>
                                <i id="coupon-toggle-icon" class="fa fa-chevron-down" style="color: #7fad39; transition: transform 0.3s;"></i>
                            </div>
                            <div id="coupon-list-collapsible" style="display: none; padding: 20px; border-top: 1px solid #eef7e4;">
                                <div id="coupon-message-area" style="display: none; text-align: center; font-weight: 500; margin-bottom: 15px; padding: 10px; border-radius: 4px;"></div>
                                <div id="coupon-list-items" style="display: flex; flex-direction: column; gap: 15px;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ìˆ˜ëŸ‰</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="display: flex; border: 1px solid #ebebeb; border-radius: 4px; overflow: hidden;">
                                    <button type="button" id="decreaseQty"
                                            style="width: 40px; height: 40px; border: none; background: #f8f9fa; cursor: pointer; font-size: 18px; color: #333;">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <input type="number" id="quantity" value="1" min="1" th:max="${book.stock}"
                                           th:data-stock="${book.stock}"
                                           style="width: 60px; height: 40px; border: none; text-align: center; font-size: 16px; font-weight: 600;"
                                           readonly>
                                    <button type="button" id="increaseQty"
                                            style="width: 40px; height: 40px; border: none; background: #f8f9fa; cursor: pointer; font-size: 18px; color: #333;">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                                <span style="color: #666; font-size: 14px;">
                                    ì¬ê³ : <span th:text="${book.stock}">10</span>ê¶Œ
                                </span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button type="button"
                                    class="site-btn"
                                    id="likeButton"
                                    style="width: 140px; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: white; color: #dc3545; border: 2px solid #dc3545; transition: all 0.3s;">

                                <span class="icon-unliked"><i class="fa fa-heart-o"></i></span> <span class="icon-liked" style="display: none;"><i class="fa fa-heart"></i></span> <span>ì¢‹ì•„ìš”</span>
                                <span id="likeCount" th:text="${bookLike.likeCount}">0</span>
                            </button>
                            <button type="button" class="site-btn" id="addToCartBtn"
                                    style="flex: 1; padding: 14px; background: #6f6f6f;">
                                <i class="fa fa-shopping-cart"></i> ì¥ë°”êµ¬ë‹ˆ
                            </button>
                        </div>
                        <div>
                            <button type="button" class="site-btn" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;"
                                    th:disabled="${book.stock == 0 or book.status.name() == 'DISCONTINUED'}"
                                    th:attr="data-book-id=${book.id}"
                                    onclick="directBuy(this)">
                                <i class="fa fa-credit-card"></i> ë°”ë¡œ êµ¬ë§¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 60px;">
                <div class="col-lg-12">
                    <div class="product__details__tab">
                        <div style="background: white; padding: 40px; border: 1px solid #ebebeb; border-radius: 4px;">

                            <h4 style="margin-bottom: 30px; font-weight: 700; padding-bottom: 15px; border-bottom: 2px solid #333;">
                                <i class="fa fa-list-ul" style="margin-right: 10px; color: #7fad39;"></i>
                                ë„ì„œ ëª©ì°¨
                            </h4>
                            <div style="font-size: 15px; line-height: 1.8; color: #555; margin-bottom: 40px; position: relative; white-space: pre-wrap;"
                                 class="truncatable-content"
                                 id="book-content">
                            </div>
                            <h4 style="margin-bottom: 30px; font-weight: 700; padding-bottom: 15px; border-bottom: 2px solid #333;">
                                <i class="fa fa-book-open" style="margin-right: 10px; color: #7fad39;"></i>
                                ë„ì„œ ì†Œê°œ
                            </h4>
                            <div style="font-size: 15px; line-height: 1.8; color: #555; position: relative; white-space: pre-wrap;"
                                 class="truncatable-content"
                                 id="explanation">
                                ë„ì„œ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI ë¦¬ë·° í•œì¤„í‰ -->
            <div th:if="${aiReview != null and aiReview != ''}"
                 style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">

                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    ğŸ’¡
                    <h4 style="font-size: 18px; font-weight: 600; color: #374151;">AI ë¦¬ë·° í•œì¤„í‰</h4>
                </div>

                <p th:text="${aiReview}"
                   style="font-size: 15px; color: #4b5563; line-height: 1.5;"></p>
            </div>

            <div class="row" style="margin-top: 60px;">
                <div class="col-lg-12">
                    <div style="background: white; padding: 40px; border: 1px solid #ebebeb; border-radius: 4px;">

                        <div style="margin-bottom: 30px;">
                            <h4 style="font-weight:700; margin-bottom: 15px;">
                                <i style="color:#ffb400; margin-right:8px;"></i>
                                í‰ê·  í‰ì 
                            </h4>

                            <div style="font-size: 32px; font-weight: 700; color: #ffb400;">
                                â˜… [[${avgScore}]]
                                <span style="color:#999; font-size:18px;"> / 5.0</span>
                            </div>
                        </div>

                        <h4 style="font-weight:700; margin-bottom:20px; border-bottom:2px solid #333; padding-bottom:10px;">
                            <i style="margin-right:8px; color:#7fad39;"></i>
                            ì‚¬ìš©ì ë¦¬ë·° (<span th:text="${reviewCount}">0</span>)
                        </h4>

                        <div th:if="${#lists.isEmpty(reviews.content)}"
                             style="text-align:center; padding:40px 0; color:#888;">
                            ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>

                        <div th:each="r : ${reviews.content}" style="border-bottom:1px solid #eee; padding:20px 0;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong th:text="${r.username}" style="font-size:16px; color:#333;"></strong>
                                <span style="color:#999;"
                                      th:text="${#temporals.format(r.createdAt, 'yyyy.MM.dd')}"></span>
                            </div>

                            <div style="color:#ffb400; font-size:18px; font-weight:700; margin:6px 0;">
                                â˜… [[${r.score}]]
                            </div>

                            <p th:text="${r.content}" style="margin:10px 0; white-space:pre-wrap;"></p>

                            <div th:if="${r.imageUrls() != null}" style="display:flex; gap:10px; flex-wrap:wrap;">
                                <img th:each="img : ${r.imageUrls()}"
                                     th:src="${img}"
                                     style="width:90px; height:90px; object-fit:cover; border-radius:4px; border:1px solid #ddd;">
                            </div>
                        </div>

                        <div style="text-align:center; margin-top:25px;">
                            <a th:if="${reviews.number > 0}"
                               th:href="@{'/books/' + ${book.id} + '?page=' + ${reviews.number - 1}}"
                               style="margin-right:10px; padding:8px 14px; border:1px solid #ccc; border-radius:4px; color:#555;">
                                ì´ì „
                            </a>

                            <a th:if="${reviews.number + 1 < reviews.totalPages}"
                               th:href="@{'/books/' + ${book.id} + '?page=' + ${reviews.number + 1}}"
                               style="padding:8px 14px; border:1px solid #ccc; border-radius:4px; color:#555;">
                                ë‹¤ìŒ
                            </a>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<th:block layout:fragment="extra-css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.5/swiper-bundle.min.css" />

    <style>
        #likeButton.liked {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }
        #likeButton.liked .icon-unliked {
            display: none;
        }
        #likeButton.liked .icon-liked {
            display: inline-block !important;
        }
        #likeButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .product-swiper-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ebebeb;
            border-radius: 4px;
            background: #f8f8f8;
        }
        .product-swiper-container .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .product-swiper-container .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .product-swiper-container .swiper-pagination-bullet-active {
            background-color: #7fad39;
        }
        .product-swiper-container .swiper-button-next,
        .product-swiper-container .swiper-button-prev {
            color: #7fad39;
            transform: scale(0.8);
        }

        .truncatable-content.truncated {
            max-height: 108px;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        .read-more-toggle {
            display: none;
            cursor: pointer;
            text-align: right;
            font-weight: 700;
            color: #7fad39;
            margin-top: 8px;
            padding-right: 5px;
        }

    </style>
</th:block>
<th:block layout:fragment="extra-js">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.5/swiper-bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        let explanation = document.querySelector('#explanation');
        if (explanation) {
            explanation.innerHTML = /*[[${book.explanation}]]*/ 'ë„ì„œ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
        }

        let bookContent = document.querySelector('#book-content');
        if (bookContent) {
            bookContent.innerHTML = /*[[${book.content}]]*/ 'ë„ì„œ ëª©ì°¨ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
        }

        async function issueCoupon(buttonElement, couponId) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'ì²˜ë¦¬ ì¤‘...';
            buttonElement.style.opacity = '0.7';

            try {
                const apiUrl = '/api-server/coupon-issue/issue';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ couponId: couponId }),
                    credentials: 'include'
                });

                if (response.redirected || response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = /*[[@{/login}]]*/ '/login';
                    return;
                }

                const contentType = response.headers.get("content-type");

                if (response.ok && contentType && !contentType.includes("application/json")) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = /*[[@{/login}]]*/ '/login';
                    return;
                }

                if (response.ok) {
                    const issuedCouponId = await response.json();
                    buttonElement.textContent = 'ë°œê¸‰ ì™„ë£Œ';
                    buttonElement.style.background = '#6f6f6f';
                    buttonElement.style.borderColor = '#6f6f6f';
                    showMessage(`ì¿ í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${issuedCouponId})`, 'success');
                } else {
                    const errorResponse = await response.json().catch(() => ({}));
                    const errorMessage = errorResponse.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';

                    buttonElement.textContent = 'ì¿ í° ë°›ê¸°';
                    buttonElement.disabled = false;
                    buttonElement.style.opacity = '1';
                    showMessage(`ë°œê¸‰ ì‹¤íŒ¨: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('ì¿ í° ë°œê¸‰ ì‹¤íŒ¨:', error);

                if (error instanceof SyntaxError) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = /*[[@{/login}]]*/ '/login';
                    return;
                }

                buttonElement.textContent = 'ì¿ í° ë°›ê¸°';
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function showMessage(text, type = 'success') {
            const messageArea = document.getElementById('coupon-message-area');
            messageArea.textContent = text;

            if(type === 'success') {
                messageArea.style.color = '#7fad39';
                messageArea.style.background = '#f8fcf3';
                messageArea.style.border = '1px solid #7fad39';
            } else {
                messageArea.style.color = '#dc3545';
                messageArea.style.background = '#fef2f2';
                messageArea.style.border = '1px solid #dc3545';
            }
            messageArea.style.display = 'block';

            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 4000);
        }

        async function loadAndSetupCoupons(bookId) {
            const container = document.getElementById('coupon-section-container');
            const trigger = document.getElementById('coupon-trigger-banner');
            const collapsible = document.getElementById('coupon-list-collapsible');
            const listItems = document.getElementById('coupon-list-items');
            const toggleIcon = document.getElementById('coupon-toggle-icon');

            try {
                const apiUrl = `/api-server/coupon-issue/downloadable`;

                const response = await fetch(`${apiUrl}/${bookId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Server response was not ok');

                const coupons = await response.json();

                if (coupons && coupons.length > 0) {

                    let html = '';
                    coupons.forEach(coupon => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${coupon.name}</div>
                                    <div style="font-size: 14px; color: #7fad39;">${coupon.discountInfo}</div>
                                </div>
                                <button
                                    class="site-btn"
                                    style="padding: 8px 15px; font-size: 14px; background: #7fad39; border-color: #7fad39; white-space: nowrap;"
                                    onclick="issueCoupon(this, ${coupon.couponId})">
                                    ì¿ í° ë°›ê¸°
                                </button>
                            </div>
                        `;
                    });
                    listItems.innerHTML = html;

                    trigger.addEventListener('click', () => {
                        const isHidden = collapsible.style.display === 'none';
                        collapsible.style.display = isHidden ? 'block' : 'none';
                        toggleIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                    });
                    container.style.display = 'block';
                }
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì¿ í° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        document.addEventListener("DOMContentLoaded", function() {

            const likeButton = document.getElementById('likeButton');
            const bookId = /*[[${book.id}]]*/ null;

            // í—¤ë” ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateHeaderWishlistCount(changeAmount) {
                const targetIds = ['header-wishlist-count', 'mobile-wishlist-count'];
                targetIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        let currentCount = parseInt(element.innerText, 10);
                        if (isNaN(currentCount)) currentCount = 0;

                        let newCount = currentCount + changeAmount;
                        if (newCount < 0) newCount = 0;

                        element.innerText = newCount;
                    }
                });
            }

            if (likeButton) {
                const likeCountElement = document.getElementById('likeCount');
                const isAlreadyLiked = /*[[${isLikedByCurrentUser}]]*/ false;
                const apiUrl = '/api-server/books/joa';

                let currentLikeCount = parseInt(likeCountElement.innerText, 10);

                if (isAlreadyLiked) {
                    likeButton.classList.add('liked');
                }

                likeButton.addEventListener('click', async function() {
                    // 1. ë‚™ê´€ì  ì—…ë°ì´íŠ¸
                    const isLiked = likeButton.classList.toggle('liked');

                    if (isLiked) {
                        currentLikeCount++;
                        updateHeaderWishlistCount(1); // í—¤ë” +1
                    } else {
                        currentLikeCount--;
                        updateHeaderWishlistCount(-1); // í—¤ë” -1
                    }
                    likeCountElement.innerText = currentLikeCount;

                    // 2. ì„œë²„ ìš”ì²­
                    try {
                        const response = await fetch(`${apiUrl}/${bookId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ liked: isLiked }),
                            credentials: 'include'
                        });

                        if (response.redirected || response.status === 401 || response.status === 403) {
                            // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                            likeButton.classList.toggle('liked');
                            if (isLiked) {
                                currentLikeCount--;
                                updateHeaderWishlistCount(-1);
                            } else {
                                currentLikeCount++;
                                updateHeaderWishlistCount(1);
                            }
                            likeCountElement.innerText = currentLikeCount;

                            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                            window.location.href = /*[[@{/login}]]*/ '/login';
                            return;
                        }

                        const contentType = response.headers.get("content-type");
                        if (response.ok && contentType && !contentType.includes("application/json")) {
                            // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                            likeButton.classList.toggle('liked');
                            if (isLiked) {
                                currentLikeCount--;
                                updateHeaderWishlistCount(-1);
                            } else {
                                currentLikeCount++;
                                updateHeaderWishlistCount(1);
                            }
                            likeCountElement.innerText = currentLikeCount;

                            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                            window.location.href = /*[[@{/login}]]*/ '/login';
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Server response was not ok');
                        }
                        // ì„±ê³µ ì‹œ ì¶”ê°€ ì‘ì—… ì—†ìŒ

                    } catch (e) {
                        console.error('ì—ëŸ¬:', e);

                        // ì—ëŸ¬ ì‹œ ë¡¤ë°±
                        likeButton.classList.toggle('liked');
                        if (isLiked) {
                            currentLikeCount--;
                            updateHeaderWishlistCount(-1);
                        } else {
                            currentLikeCount++;
                            updateHeaderWishlistCount(1);
                        }
                        likeCountElement.innerText = currentLikeCount;

                        if (e instanceof SyntaxError) {
                            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                            window.location.href = /*[[@{/login}]]*/ '/login';
                        } else {
                            alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                });
            }

            const quantityInput = document.getElementById('quantity');
            const decreaseBtn = document.getElementById('decreaseQty');
            const increaseBtn = document.getElementById('increaseQty');

            if (quantityInput && decreaseBtn && increaseBtn) {
                const stock = parseInt(quantityInput.dataset.stock);

                decreaseBtn.addEventListener('click', function() {
                    let currentQty = parseInt(quantityInput.value);
                    if (currentQty > 1) {
                        currentQty--;
                        quantityInput.value = currentQty;
                    }
                });

                increaseBtn.addEventListener('click', function() {
                    let currentQty = parseInt(quantityInput.value);
                    if (currentQty < stock) {
                        currentQty++;
                        quantityInput.value = currentQty;
                    } else {
                        alert('ì¬ê³  ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });

            }

            function setupTruncation(contentElement) {
                if (!contentElement) return;

                const placeholderText = 'ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
                if (!contentElement.innerText || contentElement.innerText.endsWith(placeholderText) || contentElement.innerText.trim() === "") {
                    contentElement.innerHTML = '<span style="color: #999;">ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    return;
                }

                const FOUR_LINES_HEIGHT = 108;

                if (contentElement.scrollHeight > FOUR_LINES_HEIGHT) {

                    contentElement.classList.add('truncated');

                    const toggleButton = document.createElement('div');
                    toggleButton.classList.add('read-more-toggle');
                    toggleButton.innerHTML = '... ë”ë³´ê¸°';
                    toggleButton.style.display = 'block';

                    contentElement.parentNode.insertBefore(toggleButton, contentElement.nextSibling);

                    toggleButton.addEventListener('click', function() {
                        const isNowTruncated = contentElement.classList.toggle('truncated');

                        if (isNowTruncated) {
                            toggleButton.innerHTML = '... ë”ë³´ê¸°';
                            contentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        } else {
                            toggleButton.innerHTML = 'ì ‘ê¸°';
                        }
                    });
                }
            }

            setupTruncation(document.querySelector('#book-content'));
            setupTruncation(document.querySelector('#explanation'));

            const swiper = new Swiper('.product-swiper-container', {
                loop: true,
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
            });

            console.log("bookId: " + bookId);
            if (bookId != null) {
                loadAndSetupCoupons(bookId);
            }
        });

        const addToCartBtn = document.getElementById('addToCartBtn');

        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', async function () {

                const bookId = /*[[${book.id}]]*/ null;
                const bookStatus = /*[[${book.status.name()}]]*/ '';
                const quantity = parseInt(document.getElementById('quantity').value, 10);
                const stock = parseInt(document.getElementById('quantity').dataset.stock);

                if (bookStatus === 'DISCONTINUED') {
                    alert('íŒë§¤ê°€ ì¤‘ì§€ëœ ë„ì„œì…ë‹ˆë‹¤.');
                    return;
                }

                if (stock === 0) {
                    alert('ì¬ê³ ê°€ ì—†ì–´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                if (quantity > stock) {
                    alert('ì¬ê³  ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ì—¬ ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const requestBody = {
                    bookId: bookId,
                    quantity: quantity
                };

                try {
                    const response = await fetch('/carts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        alert('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!');
                        return;
                    }

                    const errorData = await response.json().catch(() => null);
                    alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤íŒ¨: ' + (errorData?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));

                } catch (e) {
                    console.error('ì¥ë°”êµ¬ë‹ˆ ìš”ì²­ ì˜¤ë¥˜:', e);
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        async function directBuy(button) {
            const bookId = button.getAttribute('data-book-id');
            const quantity = document.getElementById('quantity').value;

            const requestData = {
                items: [
                    {
                        bookId: parseInt(bookId),
                        quantity: parseInt(quantity)
                    }
                ],
                orderType: 'DIRECT'  // ë°”ë¡œ êµ¬ë§¤
            };

            try {
                const response = await fetch('/orders/prepare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    credentials: 'include'
                });

                if (response.ok) {
                    const html = await response.text();
                    document.open();
                    document.write(html);
                    document.close();
                } else {
                    alert('ì£¼ë¬¸ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì£¼ë¬¸ ì¤€ë¹„ ì˜¤ë¥˜:', error);
                alert('ì£¼ë¬¸ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /*]]>*/
    </script>
</th:block>
</body>
</html>