<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${book.title} + ' | 북스캠프'">도서 상세</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <th:block layout:fragment="extra-css">
        <style>
            .book-detail-wrapper { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
            .book-detail-container { display: flex; flex-wrap: wrap; gap: 2.5rem; margin-top: 2rem; }
            .book-cover { flex: 1; min-width: 300px; max-width: 400px; }
            .book-cover img { width: 100%; border: 1px solid #ddd; border-radius: 4px; }
            .book-info { flex: 2; min-width: 300px; }
            .book-info h1 { margin-top: 0; font-size: 2.2rem; border-bottom: 2px solid #333; padding-bottom: 1rem; }
            .info-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 1rem; }
            .info-table th, .info-table td { padding: 0.8rem 0.2rem; text-align: left; border-bottom: 1px solid #f0f0f0; }
            .info-table th { width: 100px; color: #555; }
            .price-info { background-color: #f9f9f9; padding: 1.5rem; border-radius: 4px; margin: 1.5rem 0; }
            .regular-price { text-decoration: line-through; color: #888; font-size: 1rem; }
            .sale-price { font-size: 2rem; font-weight: bold; color: #d9534f; }
            .discount-rate { color: #d9534f; font-weight: bold; margin-left: 0.75rem; font-size: 1.8rem; }
            .purchase-actions { display: flex; gap: 1rem; margin-top: 2rem; }
            .purchase-actions .btn { padding: 1rem 1.5rem; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
            .btn-like { background-color: #fff; color: #d9534f; border: 1px solid #d9534f; width: 130px; flex-shrink: 0; transition: all 0.2s ease-in-out; }
            .btn-like .icon-liked { display: none; }
            .btn-like .icon-unliked { display: inline-block; }
            .btn-like.liked { background-color: #d9534f; color: white; }
            .btn-like.liked .icon-liked { display: inline-block; }
            .btn-like.liked .icon-unliked { display: none; }
            .btn-like [class^="icon-"] + span { margin-left: 0.6rem; }
            .btn-like .like-count {margin-left: 0.5rem; font-size: 1rem; font-weight: 500; vertical-align: middle;}
            .btn-cart { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; flex-grow: 1; }
            .btn-buy { background-color: #007bff; color: white; flex-grow: 1; }
            .book-explanation { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee; clear: both; }
            .book-explanation h2 { font-size: 1.8rem; border-bottom: 2px solid #555; padding-bottom: 0.5rem; }
            .book-explanation p { font-size: 1rem; line-height: 1.7; }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content" class="book-detail-wrapper">
    <div class="book-detail-container">
        <div class="book-info">
            <h1 th:text="${book.title}"></h1>

            <table class="info-table">
                <tbody>
                <tr><th>출판사</th><td th:text="${book.publisher}"></td></tr>
                <tr><th>출판일</th><td th:text="${#temporals.format(book.publishDate, 'yyyy-MM-dd')}"></td></tr>
                </tbody>
            </table>

            <div class="price-info">
                <div><span class="regular-price" th:text="${#numbers.formatInteger(book.regularPrice, 3, 'COMMA') + '원'}"></span></div>
                <div>
                    <span class="sale-price" th:text="${#numbers.formatInteger(book.salePrice, 3, 'COMMA') + '원'}"></span>
                    <span class="discount-rate" th:if="${book.regularPrice > book.salePrice}" th:text="${#numbers.formatDecimal((book.regularPrice - book.salePrice) * 100.0 / book.regularPrice, 0, 'COMMA', 0, 'POINT') + '%'}"></span>
                </div>
            </div>

            <table class="info-table">
                <tbody>
                <tr><th>재고</th><td th:text="${book.stock + '권'}"></td></tr>
                <tr><th>포장</th><td th:text="${book.packable ? '포장 가능' : '포장 불가능'}"></td></tr>
                <tr><th>조회수</th><td th:text="${book.viewCount}"></td></tr>
                </tbody>
            </table>

            <div class="purchase-actions">
                <button type="button" class="btn btn-like" id="likeButton">
                    <span class="icon-unliked"><i class="fa-regular fa-heart"></i></span>
                    <span class="icon-liked"><i class="fa-solid fa-heart"></i></span>
                    <span>좋아요</span>
                    <span id="likeCount" class="like-count" th:text="${bookLike.likeCount}">0</span>
                </button>
                <button type="button" class="btn btn-cart">장바구니</button>
                <button type="button" class="btn btn-buy">바로 구매</button>
            </div>
        </div>
    </div>

    <div class="book-explanation">
        <h2>도서 소개</h2>
        <p th:text="${book.explanation}" style="line-height: 1.7;"></p>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:inline="javascript">
        const pathPrefix = /*[[${apiPrefix}]]*/ '';
        /*<![CDATA[*/
        console.log(pathPrefix);

        document.addEventListener("DOMContentLoaded", function() {
            const likeButton = document.getElementById('likeButton');
            const likeCountElement = document.getElementById('likeCount');

            const bookId = [[${book.id}]];
            const isAlreadyLiked = [[${isLikedByCurrentUser}]];
            const apiUrl = pathPrefix + '/api-server/books/like';
            console.log(apiUrl);

            let currentLikeCount = parseInt(likeCountElement.innerText, 10);

            if (isAlreadyLiked) {
                likeButton.classList.add('liked');
            }

            likeButton.addEventListener('click', function() {
                const isLiked = likeButton.classList.toggle('liked');

                if (isLiked) {
                    currentLikeCount++;
                } else {
                    currentLikeCount--;
                }

                likeCountElement.innerText = currentLikeCount;

                fetch(`${apiUrl}/${bookId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ liked: isLiked })
                })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('Server response was not ok');
                        }
                        return res.text();
                    })
                    .then(text => {
                        if (text) {
                            console.log('서버 응답:', JSON.parse(text));
                        } else {
                            console.log('서버 응답 성공 (본문 없음)');
                        }
                    })
                    .catch(e => {
                        console.error('에러:', e);
                        alert('좋아요 처리에 실패했습니다.');
                        likeButton.classList.toggle('liked');

                        if (isLiked) {
                            currentLikeCount--;
                        } else {
                            currentLikeCount++;
                        }
                        likeCountElement.innerText = currentLikeCount;
                    });
            });
        });
    </script>
</th:block>
</body>
</html>