<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/default}">

<head>
    <meta charset="UTF-8">
    <title>카테고리 관리</title>

    <th:block layout:fragment="extra-css">
        <style>
            .category-list, .category-list-child {
                list-style: none;
                padding-left: 15px;
            }

            .category-item {
                padding: 6px 5px;
            }

            .category-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0;
            }

            .category-label {
                display: flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
            }

            .category-children {
                margin-left: 20px;
                display: none;
            }

            .expanded > .category-children {
                display: block;
            }

            .category-buttons {
                display: flex;
                gap: 6px;
            }

            .category-buttons a, .category-buttons button {
                font-size: 0.8rem;
                padding: 2px 6px;
                border-radius: 4px;
                text-decoration: none;
            }

            .btn-add-child { background: #e0f7fa; color: #00796b; }
            .btn-edit { background: #e0e0e0; color: #444; }
            .btn-delete { background: #ffebee; color: #c62828; }
        </style>
    </th:block>

    <script>
        function toggleCategory(element) {
            const item = element.closest(".category-item");
            if (item) {
                item.classList.toggle("expanded");
            }
        }

        function showEditForm(buttonElement, categoryId, currentName) {
            const row = buttonElement.closest('.category-row');
            if (!row) return;

            const existingForm = row.parentElement.querySelector('.edit-form');
            if (existingForm) {
                cancelEdit(existingForm.querySelector('button'), row.id);
            }

            row.style.display = 'none';

            const formHtml = `
                <form class="category-row edit-form" onsubmit="submitEditForm(this, ${categoryId}); return false;">
                    <input type="text" name="name" value="${currentName}" style="flex-grow: 1;" required>
                    <span class="category-buttons">
                        <button type="submit" class="btn-edit" style="border:none; cursor:pointer;">저장</button>
                        <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                onclick="cancelEdit(this, '${row.id}');">취소</button>
                    </span>
                </form>
            `;
            row.insertAdjacentHTML('afterend', formHtml);
            row.parentElement.querySelector('.edit-form input').focus();
        }

        function cancelEdit(cancelButton, originalRowId) {
            const form = cancelButton.closest('.edit-form');
            if (form) {
                form.remove();
            }
            const originalRow = document.getElementById(originalRowId);
            if (originalRow) {
                originalRow.style.display = 'flex';
            }
        }

        function showRootAddForm() {
            const rootList = document.querySelector('.category-list');
            if (!rootList) return;

            if (rootList.querySelector('.add-form-li')) {
                rootList.querySelector('.add-form-li input[name="name"]').focus();
                return;
            }

            const formHtml = `
                <li class="category-item add-form-li" style="padding-left: 0;">
                    <form class="category-row add-form" onsubmit="submitAddForm(this, null); return false;">
                        <input type="text" name="name" placeholder="새 최상위 카테고리 이름" style="flex-grow: 1;" required>
                        <span class="category-buttons">
                            <button type="submit" class="btn-add-child" style="border:none; cursor:pointer;">등록</button>
                            <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                    onclick="this.closest('.add-form-li').remove();">취소</button>
                        </span>
                    </form>
                </li>
            `;
            rootList.insertAdjacentHTML('beforeend', formHtml);
            rootList.querySelector('.add-form-li input[name="name"]').focus();
        }

        function showAddForm(buttonElement, parentId) {
            const parentItem = buttonElement.closest('.category-item');
            if (!parentItem) return;

            const childrenList = parentItem.querySelector('.category-children');
            if (!childrenList) return;

            if (childrenList.querySelector('.add-form-li')) {
                childrenList.querySelector('.add-form-li input[name="name"]').focus();
                return;
            }

            const formHtml = `
                <li class="category-item add-form-li">
                    <form class="category-row add-form" onsubmit="submitAddForm(this, ${parentId}); return false;">
                        <input type="text" name="name" placeholder="새 카테고리 이름" style="flex-grow: 1;" required>
                        <span class="category-buttons">
                            <button type="submit" class="btn-add-child" style="border:none; cursor:pointer;">등록</button>
                            <button type="button" class="btn-delete" style="border:none; cursor:pointer;"
                                    onclick="this.closest('.add-form-li').remove();">취소</button>
                        </span>
                    </form>
                </li>
            `;

            childrenList.insertAdjacentHTML('afterbegin', formHtml);

            parentItem.classList.add('expanded');
            childrenList.style.display = 'block';

            childrenList.querySelector('.add-form-li input[name="name"]').focus();
        }
    </script>

    <script th:inline="javascript">
        const pathPrefix = /*[[${apiPrefix}]]*/ '';
        /*<![CDATA[*/

        let csrfToken = null;
        let csrfHeader = null;

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        if (csrfTokenMeta && csrfHeaderMeta) {
            csrfToken = csrfTokenMeta.content;
            csrfHeader = csrfHeaderMeta.content;
        }

        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        async function submitEditForm(form, categoryId) {
            const newName = form.querySelector('input[name="name"]').value;

            const apiUrl = pathPrefix + '/api-server/admin/category/update';

            try {
                const response = await fetch(`${apiUrl}/${categoryId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ name: newName })
                });

                if (!response.ok) {
                    throw new Error('카테고리 수정에 실패했습니다.');
                }

                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        async function submitAddForm(form, parentId) {

            const newName = form.querySelector('input[name="name"]').value;

            const apiUrl = pathPrefix + '/api-server/admin/category/create';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ parentId: parentId, name: newName })
                });

                if (!response.ok) {
                    throw new Error('카테고리 추가에 실패했습니다.');
                }

                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // *** [수정됨] 삭제를 위한 AJAX 함수 추가 ***
        async function submitDelete(buttonElement, categoryId) {
            // 사용자에게 한 번 더 확인
            if (!confirm('정말 삭제할까요?')) {
                return;
            }

            // 다른 API 경로를 참고하여 삭제 API 경로 설정
            const apiUrl = pathPrefix + '/api-server/admin/category/delete';

            try {
                const response = await fetch(`${apiUrl}/${categoryId}`, {
                    method: 'DELETE',
                    headers: headers // CSRF 토큰 등이 포함된 헤더
                });

                if (!response.ok) {
                    // 서버에서 구체적인 에러 메시지를 보냈을 경우
                    // const errorData = await response.json();
                    // throw new Error(errorData.message || '카테고리 삭제에 실패했습니다.');

                    // 간단한 에러 처리
                    throw new Error('카테고리 삭제에 실패했습니다.');
                }

                // 성공 시 페이지 새로고침
                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }
        /*]]>*/
    </script>
</head>

<body>
<div layout:fragment="content">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="font-size: 1.8rem; font-weight: 600;">카테고리 목록</h1>

        <a href="#" class="btn-add-child" style="padding: 8px 12px;"
           onclick="showRootAddForm(); return false;">
            + 새 목록 추가
        </a>
    </div>

    <ul class="category-list">
        <th:block th:each="category : ${categories}">
            <th:block th:replace="~{this :: categoryItem(category=${category})}"></th:block>
        </th:block>
    </ul>

    <th:block th:fragment="categoryItem(category)">
        <li class="category-item" th:id="'category-item-' + ${category.id}">

            <div class="category-row" th:id="'category-row-' + ${category.id}">
                <span class="category-label" onclick="toggleCategory(this)">
                    <span th:text="${(category.children != null and !category.children.isEmpty()) ? '📁' : ''}"></span>
                    <span class="category-name" th:text="${category.name}">카테고리</span>
                </span>

                <span class="category-buttons">
                    <a href="#" class="btn-add-child"
                       th:onclick="showAddForm(this, [[${category.id}]]); return false;">추가</a>
                    <a href="#" class="btn-edit"
                       th:onclick="showEditForm(this, [[${category.id}]], [[${category.name}]]); return false;">수정</a>

                    <a href="#" class="btn-delete"
                       th:onclick="submitDelete(this, [[${category.id}]]); return false;">삭제</a>
                </span>
            </div>

            <ul th:if="${category.children != null and !category.children.isEmpty()}" class="category-children">
                <th:block th:each="child : ${category.children}">
                    <th:block th:replace="~{this :: categoryItem(category=${child})}"></th:block>
                </th:block>
            </ul>

            <ul th:unless="${category.children != null and !category.children.isEmpty()}" class="category-children" style="display: none;">
            </ul>

        </li>
    </th:block>

</div>
</body>
</html>