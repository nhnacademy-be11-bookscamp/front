<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <style>
        .info-label { font-weight: bold; margin-right: 10px; }
        .info-row { margin-bottom: 10px; }
    </style>
    <script th:inline="javascript">
        const currentUserId = `[[${memberInfo.userName}]]`;

        async function deleteMember() {
            if (!confirm('정말로 탈퇴하시겠습니까?\n모든 데이터가 삭제되며 복구할 수 없습니다.')) {
                return;
            }

            const url = `/members/${currentUserId}`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('회원 탈퇴가 성공적으로 처리되었습니다. 이용해 주셔서 감사합니다.');

                    window.location.href = '/login';

                } else {
                    let errorText = await response.text();

                    try {
                        const errorJson = JSON.parse(errorText);
                        errorText = errorJson.message || errorJson.error || errorText;
                    } catch (e) {
                        errorText = errorText || response.statusText;
                    }

                    alert(`회원 탈퇴 실패 (${response.status}): ${errorText}`);
                }
            } catch (error) {
                console.error('Network Fetch Error:', error);
                alert('네트워크 오류가 발생했습니다. 서버 연결을 확인하세요.');
            }
        }
    </script>
</head>
<body>

<div layout:fragment="content">
    <h1>마이페이지</h1>
    <p th:if="${memberInfo}">
        <span th:text="${memberInfo.name}">회원 이름</span>님의 정보입니다.
    </p>

    <div th:if="${memberInfo}">
        <h2>내 정보</h2>
        <div class="info-row">
            <span class="info-label">이름:</span>
            <span th:text="${memberInfo.name}">홍길동</span>
        </div>
        <div class="info-row">
            <span class="info-label">이메일:</span>
            <span th:text="${memberInfo.email}">test@example.com</span>
        </div>
        <div class="info-row">
            <span class="info-label">전화번호:</span>
            <span th:text="${memberInfo.phone}">010-1234-5678</span>
        </div>
        <div class="info-row">
            <span class="info-label">생년월일:</span>
            <span th:text="${#temporals.format(memberInfo.birthDate, 'yyyy-MM-dd')}">1990-01-01</span>
        </div>
        <div class="info-row">
            <span class="info-label">포인트:</span>
            <span th:text="${#numbers.formatInteger(memberInfo.point, 1, 'COMMA')}">10000</span> 점
        </div>

        <hr>
        <div>
            <a th:href="@{/members/edit-info/{id}(id=${memberInfo.userName})}">정보 수정</a>
            <a th:href="@{/members/{id}/change-password(id=${memberInfo.userName})}">비밀번호 변경</a>
        </div>
        <div>
            <div class="danger-zone">
                <h3>회원 탈퇴</h3>
                <button type="button" class="delete-button" id="deleteMemberButton" onclick="deleteMember()">회원 탈퇴</button>
            </div>
        </div>

    </div>

    <div th:unless="${memberInfo}">
        <p>회원 정보를 불러오지 못했습니다.</p>
    </div>

    <div style="margin-top: 2rem;">
        <p>레이아웃: <code>layouts/no-sidebar.html</code></p>
    </div>
</div>

</body>
</html>