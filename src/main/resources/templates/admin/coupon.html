<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <meta charset="UTF-8">
    <title>쿠폰 관리 | 북스캠프 관리자</title>

    <th:block layout:fragment="extra-css">
        <style>
            .btn-add-child { background: #7fad39; color: white; padding: 5px 12px; border-radius: 4px; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s; }
            .btn-add-child:hover { background: #6d9631; }
            .btn-delete { background: #dc3545; color: white; padding: 5px 12px; border-radius: 4px; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s; }
            .btn-delete:hover { background: #c82333; }

            #add-coupon-form-container { font-size: 14px; margin-bottom: 25px; padding: 25px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
            #add-coupon-form-container .form-label { font-weight: 500; margin-bottom: 5px; }
            .form-control, .form-select { font-size: 14px; padding: 8px 12px; }
            .target-id-group { display: none; }

            /* [모달 공통] */
            .scrollable-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: white; }

            /* [도서 리스트] */
            .modal-list-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s; }
            .modal-list-item:hover { background-color: #f1f8e9; }

            /* [카테고리 트리 스타일 개선] */
            .category-tree ul { list-style-type: none; padding-left: 20px; }
            .category-tree li { margin: 5px 0; position: relative; }

            /* 트리 노드 컨테이너 */
            .tree-node-container { display: flex; align-items: center; gap: 5px; }

            /* 토글 버튼 (폴더 아이콘) */
            .tree-toggle-btn { cursor: pointer; color: #FFB400; padding: 2px 5px; transition: transform 0.2s; }
            .tree-toggle-btn:hover { transform: scale(1.1); }
            .tree-toggle-btn.empty { color: #ccc; cursor: default; } /* 자식 없을 때 */

            /* 선택 가능한 이름 텍스트 */
            .tree-name-btn { cursor: pointer; padding: 2px 8px; border-radius: 4px; transition: all 0.2s; }
            .tree-name-btn:hover { background-color: #e0e0e0; color: #7fad39; font-weight: bold; }
        </style>
    </th:block>
</head>

<body>
<section layout:fragment="hero" class="hero" style="display: none;"></section>

<div layout:fragment="content">
    <section class="product spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="hero__categories">
                        <div class="hero__categories__all">
                            <i class="fa fa-bars"></i>
                            <span>관리자 메뉴</span>
                        </div>
                        <ul th:replace="~{fragment/admin-sidebar :: sidebar}">
                            <li><a href="#">메뉴</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div style="background: #ffffff; padding: 30px; border: 1px solid #ebebeb; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h4 style="margin: 0; font-weight: 700;">
                                <i class="fa fa-ticket" style="margin-right: 10px; color: #0064FF;"></i>
                                쿠폰 관리
                            </h4>
                            <a href="#" class="btn-add-child" style="padding: 8px 16px; font-size: 14px;"
                               onclick="toggleAddForm(this); return false;">
                                <i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록
                            </a>
                        </div>

                        <div id="add-coupon-form-container" style="display: none;">
                            <h5 style="font-weight: 600; margin-bottom: 20px;">새 쿠폰 정보 입력</h5>
                            <form id="add-coupon-form" onsubmit="submitAddCoupon(this); return false;">

                                <div class="mb-3">
                                    <label for="name" class="form-label">쿠폰 이름 (*)</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="targetType" class="form-label">적용 대상 (*)</label>
                                        <select class="form-select" id="targetType" name="targetType" required onchange="onTargetTypeChange(this.value)">
                                            <option value="CATEGORY">카테고리</option>
                                            <option value="BOOK">도서</option>
                                            <option value="WELCOME">신규가입</option>
                                            <option value="BIRTHDAY">생일</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3 target-id-group">
                                        <label class="form-label">대상 선택 (*)</label>
                                        <div class="input-group">
                                            <input type="hidden" id="targetId" name="targetId">
                                            <input type="text" class="form-control" id="targetName" placeholder="대상을 검색하세요" readonly style="background-color: #fff;">
                                            <button class="btn btn-outline-secondary" type="button" onclick="openTargetModal()">
                                                <i class="fa fa-search"></i> 검색
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="discountType" class="form-label">할인 유형 (*)</label>
                                        <select class="form-select" id="discountType" name="discountType" required>
                                            <option value="AMOUNT">정액 할인 (원)</option>
                                            <option value="RATE">정률 할인 (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="discountValue" class="form-label">할인 값 (*)</label>
                                        <input type="number" class="form-control" id="discountValue" name="discountValue" placeholder="정액: 1000 (원), 정률: 10 (%)" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="minOrderAmount" class="form-label">최소 주문 금액 (원) (*)</label>
                                        <input type="number" class="form-control" id="minOrderAmount" name="minOrderAmount" value="0" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="maxDiscountAmount" class="form-label">최대 할인 금액 (원)</label>
                                        <input type="number" class="form-control" id="maxDiscountAmount" name="maxDiscountAmount" placeholder="정률 할인 시 입력 (선택)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="validDays" class="form-label">유효 기간 (일)</label>
                                        <input type="number" class="form-control" id="validDays" name="validDays" placeholder="발급일로부터 유효한 일수 (예: 30)">
                                    </div>
                                </div>
                                <div class="text-end" style="margin-top: 10px;">
                                    <button type="button" class="btn btn-secondary" style="font-size: 14px; padding: 6px 14px;" onclick="toggleAddForm(null);">취소</button>
                                    <button type="submit" class="btn-add-child" style="border:none; font-size: 14px; padding: 7px 14px;">쿠폰 생성</button>
                                </div>
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>쿠폰 이름</th>
                                    <th>적용 대상</th>
                                    <th>대상 ID</th>
                                    <th>할인</th>
                                    <th>최소 주문</th>
                                    <th>최대 할인</th>
                                    <th>유효일</th>
                                    <th>관리</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="coupon : ${coupons}" th:id="'coupon-row-' + ${coupon.id}">
                                    <td th:text="${coupon.id}">1</td>
                                    <td th:text="${coupon.name}">신규가입 쿠폰</td>
                                    <td th:text="${coupon.targetType}">WELCOME</td>
                                    <td th:text="${coupon.targetId}">-</td>
                                    <td th:text="${coupon.discountType.toString() == 'RATE'} ? ${coupon.discountValue} + '%' : ${#numbers.formatDecimal(coupon.discountValue, 0, 'COMMA', 0, 'POINT')} + '원'">
                                        10%
                                    </td>
                                    <td th:text="${#numbers.formatDecimal(coupon.minOrderAmount, 0, 'COMMA', 0, 'POINT')} + '원'">
                                        10,000원
                                    </td>
                                    <td th:text="${coupon.maxDiscountAmount != null} ? ${#numbers.formatDecimal(coupon.maxDiscountAmount, 0, 'COMMA', 0, 'POINT')} + '원' : '-'">
                                        5,000원
                                    </td>
                                    <td th:text="${coupon.validDays != null} ? ${coupon.validDays} + '일' : '-'">30일</td>
                                    <td>
                                        <button class="btn-delete" style="border:none; cursor:pointer;"
                                                th:onclick="'submitDelete(this, ' + ${coupon.id} + ');'">삭제</button>
                                    </td>
                                </tr>
                                <tr th:if="${coupons == null or #lists.isEmpty(coupons)}">
                                    <td colspan="9" class="text-center" style="padding: 30px;">
                                        등록된 쿠폰이 없습니다.
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="categorySelectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">카테고리 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2">* 폴더 아이콘을 클릭하면 하위 카테고리가 펼쳐집니다.</p>
                    <div id="categoryTreeContainer" class="scrollable-list category-tree">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookSearchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">도서 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="bookSearchInput" class="form-control" placeholder="도서 제목을 입력하세요 (엔터 시 검색)" onkeyup="if(event.key === 'Enter') searchBooks(0)">
                        <button class="btn btn-outline-primary" type="button" onclick="searchBooks(0)">검색</button>
                    </div>

                    <div id="bookListContainer" class="scrollable-list" style="height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted p-3">검색어를 입력하고 검색 버튼을 눌러주세요.</div>
                    </div>

                    <div id="bookPagination" class="d-flex justify-content-center align-items-center mt-3" style="gap: 10px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="extra-js">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // 1. 공통 설정 및 데이터 로드
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
        if (csrfTokenMeta && csrfHeaderMeta) {
            headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        }

        // 서버 Advice에서 내려준 카테고리 데이터
        const globalCategories = /*[[${categories}]]*/ [];

        let categoryModal = null;
        let bookModal = null;
        let currentSearchKeyword = '';

        // [핵심] window.onload로 실행 시점 늦춤 (Bootstrap 로드 대기)
        window.addEventListener('load', function() {

            // 부트스트랩 로드 확인
            if (typeof bootstrap === 'undefined') {
                console.error("Bootstrap 라이브러리 로드 실패");
                return;
            }

            categoryModal = new bootstrap.Modal(document.getElementById('categorySelectModal'));
            bookModal = new bootstrap.Modal(document.getElementById('bookSearchModal'));
            onTargetTypeChange(document.getElementById('targetType').value);
        });

        // --------------------------------------------------------
        // [1] 카테고리 트리 (최상위만 보이고 하위는 접기)
        // --------------------------------------------------------
        function renderCategoryTree() {
            const container = document.getElementById('categoryTreeContainer');
            if (!globalCategories || globalCategories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">등록된 카테고리가 없습니다.</div>';
                return;
            }

            function buildHtml(cats, isRoot = false) {
                if (!cats || cats.length === 0) return '';

                // Root(최상위)는 보이고(block), 자식들은 숨김(none)으로 시작
                const displayStyle = isRoot ? 'block' : 'none';
                let html = `<ul style="display: ${displayStyle};">`;

                cats.forEach(c => {
                    const hasChildren = c.children && c.children.length > 0;
                    const safeName = c.name.replace(/'/g, "\\'");

                    const iconClass = hasChildren ? 'fa fa-folder' : 'fa fa-file-o';
                    const toggleAttr = hasChildren ? 'onclick="toggleChildren(this)"' : '';
                    const toggleClass = hasChildren ? 'tree-toggle-btn' : 'tree-toggle-btn empty';

                    html += `
                        <li>
                            <div class="tree-node-container">
                                <i class="${iconClass} ${toggleClass}" ${toggleAttr}></i>
                                <span class="tree-name-btn" onclick="selectTarget(${c.id}, '${safeName}')">
                                    ${c.name} <span style="color:#999; font-size:12px;">(ID:${c.id})</span>
                                </span>
                            </div>
                            ${hasChildren ? buildHtml(c.children, false) : ''}
                        </li>
                    `;
                });
                html += '</ul>';
                return html;
            }
            container.innerHTML = buildHtml(globalCategories, true);
        }

        function toggleChildren(iconElement) {
            const parentLi = iconElement.closest('li');
            const childUl = parentLi.querySelector('ul');

            if (childUl) {
                const isHidden = childUl.style.display === 'none';
                childUl.style.display = isHidden ? 'block' : 'none';

                if (isHidden) {
                    iconElement.classList.remove('fa-folder');
                    iconElement.classList.add('fa-folder-open');
                } else {
                    iconElement.classList.remove('fa-folder-open');
                    iconElement.classList.add('fa-folder');
                }
            }
        }


        // --------------------------------------------------------
        // [2] 도서 검색 (검색어 필수)
        // --------------------------------------------------------
        async function searchBooks(page = 0) {
            const inputKeyword = document.getElementById('bookSearchInput').value;

            if (page === 0) {
                currentSearchKeyword = inputKeyword;
            }

            if (!currentSearchKeyword || currentSearchKeyword.trim() === '') {
                alert('검색어를 입력하세요');
                return;
            }

            const container = document.getElementById('bookListContainer');
            const paginationContainer = document.getElementById('bookPagination');

            if(page === 0) container.innerHTML = '<div class="text-center p-3">검색 중...</div>';

            const safeKeyword = encodeURIComponent(currentSearchKeyword);
            const apiUrl = `/api-server/admin/books/coupon?keyword=${safeKeyword}&page=${page}&size=5`;

            try {
                const res = await fetch(apiUrl);

                if (!res.ok) {
                    console.error("API Error:", res.status);
                    throw new Error('조회 실패');
                }

                const pageData = await res.json();
                const books = pageData.content;

                if (!books || books.length === 0) {
                    container.innerHTML = '<div class="text-center p-3">검색 결과가 없습니다.</div>';
                    paginationContainer.innerHTML = '';
                    return;
                }

                let html = '';
                books.forEach(b => {
                    const safeTitle = b.title.replace(/'/g, "\\'");
                    const author = b.author ? b.author : '-';
                    const price = b.salePrice ? b.salePrice.toLocaleString() + '원' : '-';

                    html += `
                        <div class="modal-list-item d-flex justify-content-between align-items-center"
                             onclick="selectTarget(${b.id}, '${safeTitle}')">
                            <div>
                                <strong>${b.title}</strong>
                                <br><small class="text-muted">ID: ${b.id} </small>
                            </div>
                            <button class="btn btn-sm btn-outline-success">선택</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
                renderPagination(pageData);

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-danger p-3">오류가 발생했습니다.</div>';
                paginationContainer.innerHTML = '';
            }
        }

        function renderPagination(pageData) {
            const container = document.getElementById('bookPagination');
            const current = pageData.number;
            const total = pageData.totalPages;
            const first = pageData.first;
            const last = pageData.last;

            if (total <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button class="btn btn-sm btn-outline-secondary" ${first ? 'disabled' : ''} onclick="searchBooks(${current - 1})"><i class="fa fa-chevron-left"></i></button>`;
            html += `<span class="mx-3" style="font-weight:bold;">${current + 1} / ${total}</span>`;
            html += `<button class="btn btn-sm btn-outline-secondary" ${last ? 'disabled' : ''} onclick="searchBooks(${current + 1})"><i class="fa fa-chevron-right"></i></button>`;

            container.innerHTML = html;
        }


        // --------------------------------------------------------
        // [3] 공통 UI 및 이벤트
        // --------------------------------------------------------
        function toggleAddForm(button) {
            const container = document.getElementById('add-coupon-form-container');
            const isVisible = container.style.display === 'block';
            container.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                onTargetTypeChange(document.getElementById('targetType').value);
            }

            if (button) {
                if (isVisible) {
                    button.innerHTML = '<i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록';
                } else {
                    button.innerHTML = '<i class="fa fa-times" style="margin-right: 5px;"></i>등록 취소';
                    document.getElementById('add-coupon-form').reset();
                    document.getElementById('targetId').value = '';
                    document.getElementById('targetName').value = '';
                    document.getElementById('name').focus();
                    onTargetTypeChange(document.getElementById('targetType').value);
                }
            } else if (isVisible) {
                const mainButton = document.querySelector('a[onclick^="toggleAddForm"]');
                if (mainButton) mainButton.innerHTML = '<i class="fa fa-plus" style="margin-right: 5px;"></i>새 쿠폰 등록';
            }
        }

        function onTargetTypeChange(targetType) {
            const targetIdGroup = document.querySelector('.target-id-group');
            document.getElementById('targetId').value = '';
            document.getElementById('targetName').value = '';

            if (targetType === 'CATEGORY' || targetType === 'BOOK') {
                targetIdGroup.style.display = 'block';
            } else {
                targetIdGroup.style.display = 'none';
            }
        }

        function openTargetModal() {
            const targetType = document.getElementById('targetType').value;

            if (targetType === 'CATEGORY') {
                renderCategoryTree();
                categoryModal.show();
            } else if (targetType === 'BOOK') {
                // 검색창 초기화 (자동 검색 안 함)
                document.getElementById('bookSearchInput').value = '';
                document.getElementById('bookListContainer').innerHTML = '<div class="text-center text-muted p-3">검색어를 입력하고 검색 버튼을 눌러주세요.</div>';
                document.getElementById('bookPagination').innerHTML = '';
                bookModal.show();
            } else {
                alert('카테고리 또는 도서를 선택해야 검색할 수 있습니다.');
            }
        }

        function selectTarget(id, name) {
            document.getElementById('targetId').value = id;
            document.getElementById('targetName').value = name;
            categoryModal.hide();
            bookModal.hide();
        }

        async function submitAddCoupon(form) {
            if (!confirm('새 쿠폰을 생성하시겠습니까?')) return;

            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { if (value) data[key] = value; });

            if ((data.targetType === 'CATEGORY' || data.targetType === 'BOOK') && !data.targetId) {
                alert('적용 대상(카테고리/도서)을 선택해주세요.');
                return;
            }

            if(data.targetId) data.targetId = parseInt(data.targetId); else data.targetId = null;
            data.discountValue = parseInt(data.discountValue);
            data.minOrderAmount = parseInt(data.minOrderAmount);
            if(data.maxDiscountAmount) data.maxDiscountAmount = parseInt(data.maxDiscountAmount); else data.maxDiscountAmount = null;
            if(data.validDays) data.validDays = parseInt(data.validDays); else data.validDays = null;

            const apiUrl = '/api-server/admin/coupons';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                if (!response.ok) {
                    let errorMsg = '실패';
                    try { const e = await response.json(); errorMsg += `\n${e.message}`; } catch(e){}
                    throw new Error(errorMsg);
                }
                alert('생성되었습니다.');
                location.reload();
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }

        async function submitDelete(buttonElement, couponId) {
            if (!confirm('삭제하시겠습니까?')) return;
            const apiUrl = '/api-server/admin/coupons';
            try {
                const response = await fetch(`${apiUrl}/${couponId}`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('삭제 실패');
                alert('삭제되었습니다.');
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        }

        /*]]>*/
    </script>

    <script>
        $(document).ready(function() {
            $('.admin-category-header').on('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                var menuId = $(this).data('admin-menu');
                $('#admin-menu-' + menuId).slideToggle(300);
                $(this).find('.admin-toggle').toggleClass('active');
            });
        });
    </script>
</div>
</body>
</html>