<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <meta charset="UTF-8">
    <title>Î¶¨Î∑∞ ÏàòÏ†ï | Î∂ÅÏä§Ï∫†ÌîÑ</title>

    <style>
        body {
            background: #f8f9fa;
        }

        .review-box {
            background: #fff;
            padding: 30px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-top: 40px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        /* ‚≠ê Î≥ÑÏ†ê */
        .stars .star {
            font-size: 32px;
            color: #ccc;
            cursor: pointer;
            transition: 0.2s;
        }
        .stars .star.selected {
            color: #ffcc00;
        }

        /* Ïù¥ÎØ∏ÏßÄ */
        .img-box {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }

        .img-item {
            position: relative;
        }

        .img-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .img-item button {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220,53,69,0.85);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
        }

        .site-btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 12px;
            font-size: 16px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            transition: 0.2s;
        }
        .site-btn:hover {
            background: #0069d9;
        }
    </style>
</head>

<body>

<!-- üö´ Î∞∞ÎÑà Ï†úÍ±∞ -->
<section layout:fragment="hero" style="display:none;"></section>

<!-- üö´ ÏÇ¨Ïù¥ÎìúÎ∞î Ï†úÍ±∞ ‚Üí col-lg-8 offset-lg-2 Íµ¨Ï°∞ -->
<section layout:fragment="content">
    <div class="container">
        <div class="row justify-content-center">

            <div class="col-lg-8 review-box">

                <h4 style="font-weight:700; margin-bottom:25px;">Î¶¨Î∑∞ ÏàòÏ†ï</h4>

                <form th:action="@{/mypage/reviews}" method="post" enctype="multipart/form-data">

                    <input type="hidden" name="_method" value="put">
                    <input type="hidden" name="reviewId" th:value="${review.reviewId}">
                    <input type="hidden" id="removedUrls" name="removedImageUrls">

                    <!-- ‚≠ê ÌèâÏ†ê -->
                    <div style="margin-bottom:20px;">
                        <label style="font-weight:600;">ÌèâÏ†ê</label>
                        <div class="stars">
                            <i class="fa fa-star star" data-value="1"></i>
                            <i class="fa fa-star star" data-value="2"></i>
                            <i class="fa fa-star star" data-value="3"></i>
                            <i class="fa fa-star star" data-value="4"></i>
                            <i class="fa fa-star star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="score" id="scoreInput" th:value="${review.score}">
                    </div>

                    <!-- ÎÇ¥Ïö© -->
                    <div style="margin-bottom:20px;">
                        <label style="font-weight:600;">Î¶¨Î∑∞ ÎÇ¥Ïö©</label>
                        <textarea name="content"
                                  style="width:100%; height:140px; border:1px solid #ccc; padding:12px; border-radius:4px;"
                                  th:text="${review.content}"></textarea>
                    </div>

                    <!-- Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ -->
                    <div style="margin-bottom:20px;">
                        <label style="font-weight:600;">Îì±Î°ùÎêú Ïù¥ÎØ∏ÏßÄ</label>
                        <div class="img-box">
                            <div class="img-item" th:each="img : ${review.imageUrls}">
                                <img th:src="${img}">
                                <button type="button" class="btn-remove" th:data-url="${img}">√ó</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÉà Ïù¥ÎØ∏ÏßÄ -->
                    <div style="margin-bottom:20px;">
                        <label style="font-weight:600;">ÏÉà Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</label>
                        <input type="file" id="newImageUpload" name="files" multiple accept="image/*">
                        <div id="newPreview" class="img-box"></div>
                    </div>

                    <button type="submit" class="site-btn">
                        Î≥ÄÍ≤Ω ÎÇ¥Ïö© Ï†ÄÏû•
                    </button>

                </form>

            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="extra-js">
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {

            /* ‚≠ê Í∏∞Ï°¥ ÌèâÏ†ê Î°úÎî© */
            const stars = document.querySelectorAll(".star");
            const scoreInput = document.getElementById("scoreInput");
            let currentScore = /*[[${review.score}]]*/ 0;

            stars.forEach(s => {
                if (s.dataset.value <= currentScore) s.classList.add("selected");
            });

            stars.forEach(star => {
                star.addEventListener("click", function () {
                    const rating = this.dataset.value;
                    scoreInput.value = rating;

                    stars.forEach(s => {
                        s.classList.remove("selected");
                        if (s.dataset.value <= rating) s.classList.add("selected");
                    });
                });
            });

            /* üóë Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞ */
            const removed = [];
            document.addEventListener("click", e => {
                const btn = e.target.closest(".btn-remove");
                if (btn) {
                    removed.push(btn.dataset.url);
                    document.getElementById("removedUrls").value = removed.join(",");
                    btn.closest(".img-item").remove();
                }
            });

            /* üÜï ÏÉà Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */
            const fileInput = document.getElementById("newImageUpload");
            const preview = document.getElementById("newPreview");

            fileInput.addEventListener("change", function () {
                preview.innerHTML = "";

                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement("div");
                        div.classList.add("img-item");
                        div.innerHTML = `<img src="${e.target.result}">`;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            });

        });
    </script>
</th:block>

</body>
</html>
