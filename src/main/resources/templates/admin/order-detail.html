<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>주문 상세 | 북스캠프</title>

    <th:block layout:fragment="extra-css">
        <style>
            .order-detail-title {
                font-size: 1.5rem;
                font-weight: 700;
            }
            .order-detail-subtitle {
                color: #6c757d;
                margin-bottom: 1.5rem;
            }
            .order-summary-pill {
                background-color: #f8f9fa;
                border-radius: 999px;
                padding: 0.75rem 1.25rem;
                display: inline-flex;
                align-items: center;
                gap: 1.5rem;
                font-size: 0.95rem;
            }
            .order-summary-pill .label {
                color: #6c757d;
                margin-right: 0.25rem;
            }
            .section-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 1rem;
            }
            .order-item-row {
                padding: 1rem 0;
                border-top: 1px solid #f1f1f1;
            }
            .order-item-row:last-child {
                border-bottom: 1px solid #f1f1f1;
            }
            .order-item-title {
                font-weight: 500;
                margin-bottom: 0.25rem;
            }
            .order-item-meta {
                font-size: 0.9rem;
                color: #6c757d;
            }
            .order-section {
                margin-top: 2rem;
            }
            .order-section .card {
                border-radius: 0.75rem;
            }
            .order-section .card-body {
                padding: 1.5rem 1.75rem;
            }
            .order-label {
                font-size: 0.9rem;
                color: #6c757d;
            }
            .order-value {
                font-size: 0.95rem;
            }
            .order-total-row {
                border-top: 1px solid #e9ecef;
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                font-weight: 700;
            }
            .status-change-section {
                background-color: #fff9e6;
                border: 1px solid #ffe066;
                border-radius: 0.5rem;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
            }
            .status-change-section .section-title {
                color: #856404;
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            .btn-update-status {
                background-color: #0064FF;
                color: white;
                border: none;
                padding: 0.5rem 1.5rem;
                border-radius: 0.375rem;
                font-weight: 500;
            }
            .btn-update-status:hover {
                background-color: #0052cc;
                color: white;
            }
        </style>
    </th:block>
</head>

<body>
    <!-- Hero 섹션 비우기 -->
    <section layout:fragment="hero" class="hero" style="display: none;">
    </section>

    <!-- 메인 콘텐츠 -->
    <div layout:fragment="content">
        <section class="product spad">
            <div class="container">
                <div class="row">
                    <!-- 관리자 사이드바 -->
                    <div class="col-lg-3">
                        <div class="hero__categories">
                            <div class="hero__categories__all">
                                <i class="fa fa-bars"></i>
                                <span>관리자 메뉴</span>
                            </div>
                            <ul th:replace="~{fragment/admin-sidebar :: sidebar}">
                                <li><a href="#">메뉴</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- 주문 상세 영역 -->
                    <div class="col-lg-9">
                        <div style="background: #ffffff; padding: 30px; border: 1px solid #ebebeb; border-radius: 4px;">
                            <h4 class="order-detail-title">
                                <i class="fa fa-file-text-o" style="margin-right: 10px; color: #0064FF;"></i>
                                주문 상세
                            </h4>
                            <p class="order-detail-subtitle">주문 정보를 조회하고 관리할 수 있습니다.</p>

                            <div th:if="${order != null}">
                                <!-- 주문 상태 변경 섹션 (관리자 전용) -->
                                <div class="status-change-section">
                                    <div class="section-title">
                                        <i class="fa fa-exclamation-circle"></i>
                                        주문 상태 관리
                                    </div>
                                    <form id="statusChangeForm">
                                        <div class="row align-items-end">
                                            <div class="col-md-8">
                                                <label for="orderStatus" class="form-label mb-1">주문 상태</label>
                                                <select id="orderStatus" name="orderStatus" class="form-select">
                                                    <option value="AWAITING_PAYMENT" th:selected="${order.orderStatus() == 'AWAITING_PAYMENT'}">결제 대기</option>
                                                    <option value="PENDING" th:selected="${order.orderStatus() == 'PENDING'}">배송 준비</option>
                                                    <option value="SHIPPING" th:selected="${order.orderStatus() == 'SHIPPING'}">배송 중</option>
                                                    <option value="DELIVERED" th:selected="${order.orderStatus() == 'DELIVERED'}">배송 완료</option>
                                                    <option value="RETURNED" th:selected="${order.orderStatus() == 'RETURNED'}">반품</option>
                                                    <option value="CANCELLED" th:selected="${order.orderStatus() == 'CANCELLED'}">취소</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mt-3 mt-md-0">
                                                <button type="button" class="btn btn-update-status w-100" onclick="updateOrderStatus()">
                                                    <i class="fa fa-save"></i>
                                                    상태 변경
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- 상단 주문 요약 -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                                        <div>
                                            <div class="mb-2">
                                                <span class="badge bg-secondary-subtle text-secondary fw-semibold"
                                                      id="currentStatusBadge"
                                                      th:text="${order.orderStatus()}">
                                                    주문상태
                                                </span>
                                            </div>
                                            <div class="order-summary-pill">
                                                <span>
                                                    <span class="label">주문일</span>
                                                    <span th:text="${#temporals.format(order.orderDate(), 'yyyy.MM.dd')}"></span>
                                                </span>
                                                <span>
                                                    <span class="label">주문번호</span>
                                                    <span th:text="${order.orderId()}"></span>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-md-end">
                                            <div class="order-label">결제 금액</div>
                                            <div class="fs-5 fw-bold"
                                                 th:text="${#numbers.formatInteger(order.finalPaymentAmount(), 3, 'COMMA')} + '원'">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 배송(상품 목록) 섹션 -->
                                <section class="order-section">
                                    <h3 class="section-title">배송</h3>
                                    <div class="card shadow-sm">
                                        <div class="card-body">
                                            <div th:if="${#lists.isEmpty(order.items())}">
                                                <p class="text-muted mb-0">주문 상품 정보가 없습니다.</p>
                                            </div>

                                            <div th:each="item : ${order.items()}" class="order-item-row row">
                                                <div class="col-12 col-md-8">
                                                    <div class="order-item-title" th:text="${item.bookTitle()}"></div>
                                                    <div class="order-item-meta">
                                                        수량:
                                                        <span th:text="${item.orderQuantity()}"></span>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
                                                    <div class="order-value fw-semibold"
                                                         th:text="${#numbers.formatInteger(item.bookTotalAmount(), 3, 'COMMA')} + '원'">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- 배송 정보 섹션 -->
                                <section class="order-section">
                                    <h3 class="section-title">배송 정보</h3>
                                    <div class="card shadow-sm">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="order-label">수령인 / 전화번호</div>
                                                <div class="order-value">
                                                    <span th:text="${order.recipientName()}"></span>
                                                    <span th:if="${order.recipientPhone() != null and !order.recipientPhone().isEmpty()}">
                                                        &nbsp;/&nbsp;<span th:text="${order.recipientPhone()}"></span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-label">배송지 정보</div>
                                                <div class="order-value" th:text="${order.deliveryAddress()}"></div>
                                            </div>
                                            <div>
                                                <div class="order-label">배송 요청사항</div>
                                                <div class="order-value text-muted"
                                                     th:text="${order.deliveryMemo() != null ? order.deliveryMemo() : '요청사항 없음'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- 결제 정보 섹션 -->
                                <section class="order-section">
                                    <h3 class="section-title">결제 정보</h3>
                                    <div class="card shadow-sm">
                                        <div class="card-body">
                                            <div class="row mb-1">
                                                <div class="col-6 order-label">상품 금액</div>
                                                <div class="col-6 text-end order-value"
                                                     th:text="${#numbers.formatInteger(order.productAmount(), 3, 'COMMA')} + '원'">
                                                </div>
                                            </div>
                                            <div class="row mb-1">
                                                <div class="col-6 order-label">배송비</div>
                                                <div class="col-6 text-end order-value"
                                                     th:text="${#numbers.formatInteger(order.deliveryFee(), 3, 'COMMA')} + '원'">
                                                </div>
                                            </div>
                                            <div class="row mb-1">
                                                <div class="col-6 order-label">포장비</div>
                                                <div class="col-6 text-end order-value"
                                                     th:text="${#numbers.formatInteger(order.packagingFee(), 3, 'COMMA')} + '원'">
                                                </div>
                                            </div>
                                            <div class="row mb-1">
                                                <div class="col-6 order-label">할인 금액</div>
                                                <div class="col-6 text-end order-value text-danger"
                                                     th:text="'-' + ${#numbers.formatInteger(order.discountAmount(), 3, 'COMMA')} + '원'">
                                                </div>
                                            </div>
                                            <div class="row mb-1">
                                                <div class="col-6 order-label">사용 포인트</div>
                                                <div class="col-6 text-end order-value text-danger"
                                                     th:text="'-' + ${#numbers.formatInteger(order.usedPoint(), 3, 'COMMA')} + 'P'">
                                                </div>
                                            </div>

                                            <div class="row order-total-row">
                                                <div class="col-6">결제 금액</div>
                                                <div class="col-6 text-end fs-5"
                                                     th:text="${#numbers.formatInteger(order.finalPaymentAmount(), 3, 'COMMA')} + '원'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- 목록으로 돌아가기 -->
                                <div class="mt-4 text-center">
                                    <a th:href="@{/admin/orders}" class="btn btn-outline-secondary">
                                        <i class="fa fa-list"></i>
                                        주문 목록으로
                                    </a>
                                </div>
                            </div>

                            <!-- order 가 null 인 경우 -->
                            <div th:if="${order == null}">
                                <p class="text-center text-muted">주문 정보를 불러올 수 없습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 추가 JavaScript -->
    <div layout:fragment="extra-js">
        <script th:inline="javascript">
            $(document).ready(function() {
                // 관리자 사이드바 전용 토글
                $('.admin-category-header').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    var menuId = $(this).data('admin-menu');
                    var $submenu = $('#admin-menu-' + menuId);
                    var $toggle = $(this).find('.admin-toggle');

                    $toggle.toggleClass('active');
                    $submenu.slideToggle(300);
                });

                // 초기화: aria 속성 설정
                $('.admin-toggle').attr('role', 'button');
                $('.admin-toggle').attr('aria-expanded', 'false');
                $('.admin-toggle').attr('tabindex', '0');
            });

            // 주문 상태 변경 함수
            async function updateOrderStatus() {
                const orderId = /*[[${order.orderId()}]]*/ 0;
                const currentStatus = /*[[${order.orderStatus()}]]*/ '';
                const newStatus = $('#orderStatus').val();

                // 디버깅용 콘솔 로그
                console.log('현재 상태:', currentStatus, '| 변경할 상태:', newStatus);

                // 현재 상태와 동일하면 변경하지 않음
                if (currentStatus === newStatus) {
                    alert('현재 상태와 동일합니다.');
                    return;
                }

                // 상태 변경 가능 여부 체크
                if (!canChangeStatus(currentStatus, newStatus)) {
                    alert('잘못된 상태 전환입니다.\n\n현재 상태: ' + getStatusText(currentStatus) + ' (' + currentStatus + ')' + '\n변경할 상태: ' + getStatusText(newStatus) + ' (' + newStatus + ')' + '\n\n상태 전환 규칙을 확인해주세요.');
                    return;
                }

                if (!confirm('주문 상태를 "' + getStatusText(newStatus) + '"(으)로 변경하시겠습니까?')) {
                    return;
                }

                try {
                    const response = await fetch(`/admin/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderStatus: newStatus
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || '주문 상태 변경에 실패했습니다.');
                    }

                    const result = await response.json();
                    alert('주문 상태가 성공적으로 변경되었습니다.\n\n변경된 상태: ' + getStatusText(result.currentStatus));

                    // 페이지 새로고침
                    location.reload();

                } catch (error) {
                    alert('주문 상태 변경 중 오류가 발생했습니다.\n\n' + error.message);
                }
            }

            // 상태 전환 가능 여부 체크
            function canChangeStatus(currentStatus, newStatus) {
                // 변경 불가능한 상태
                if (currentStatus === 'CANCELLED' || currentStatus === 'RETURNED') {
                    return false;
                }

                // AWAITING_PAYMENT는 관리자가 변경 불가
                if (currentStatus === 'AWAITING_PAYMENT') {
                    return false;
                }

                // 상태 전환 규칙
                const allowedTransitions = {
                    'PENDING': ['SHIPPING'],
                    'SHIPPING': ['DELIVERED'],
                    'DELIVERED': ['RETURNED']
                };

                const allowed = allowedTransitions[currentStatus];
                return allowed && allowed.includes(newStatus);
            }

            // 상태 코드를 한글로 변환
            function getStatusText(status) {
                const statusMap = {
                    'AWAITING_PAYMENT': '결제 대기',
                    'PENDING': '배송 준비',
                    'SHIPPING': '배송 중',
                    'DELIVERED': '배송 완료',
                    'RETURNED': '반품',
                    'CANCELLED': '취소'
                };
                return statusMap[status] || status;
            }
        </script>
    </div>
</body>
</html>